<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 8: Protocol Bridging" />
      <MSHelp:RLTitle Title="Exercise 8: Protocol Bridging" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 8: Protocol Bridging</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/script.js" type="text/javascript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">What's New in WCF 4?</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 8: Protocol Bridging</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
      <table width="100%" id="bottomTable" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <span onclick="ExpandCollapseAll(toggleAllImage)" onkeypress="ExpandCollapseAll_CheckKey(toggleAllImage)" tabindex="0" style="cursor:default;display:none;">
              <img id="toggleAllImage" class="toggleAll" alt="CollapseAll image" src="../local/collall.gif" />
              <label id="collapseAllLabel" for="toggleAllImage" style="display: none;">Collapse All</label>
              <label id="expandAllLabel" for="toggleAllImage" style="display: none;">Expand All</label> </span>
            <span id="languageFilterToolTip" onmouseover="languageFilterImage.src=dropDownHoverImage.src;" onmouseout="languageFilterImage.src=dropDownImage.src;" tabindex="0" style="cursor:default;">
              <img id="languageFilterImage" alt="DropDown image" src="../local/drpdown.gif" />
              <label id="showAllLabel" for="languageFilterImage" style="display: none;">Language Filter: All</label>
              <label id="multipleLabel" for="languageFilterImage" style="display: none;">Language Filter: Multiple</label>
              <label id="vbLabel" for="languageFilterImage" style="display: none;">Language Filter: Visual Basic</label>
              <label id="csLabel" for="languageFilterImage" style="display: none;">Language Filter: C#</label>
            </span>
          </td>
        </tr>
      </table>
      <div id="languageSpan">
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="vbUsageCheckbox" />
        <label class="languageFilter" for="vbUsageCheckbox">Visual Basic Usage</label>
        <br />
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="csCheckbox" />
        <label class="languageFilter" for="csCheckbox">C#</label>
        <br />
      </div>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>WCF4 includes a new routing service found in the <b>System.ServiceModel.Routing</b> namespace. The Routing Service is designed to act as a generic, configurable SOAP intermediary. It allows you to configure Content Based Routing, set up Protocol Bridging, and handle communication errors that you encounter. The Routing Service also makes it possible for you to update your Routing Configuration while the Routing Service is running without restarting the service.</p>
        <p>
          <img src="images\631b0ee8-e687-4c30-b30d-27dffd67b091.png" />
        </p>
        <p>
          <b>Figure 28</b>
          <br />
          <i>The routing service bridging http and net.tcp</i>
        </p>
        <br />
        <p>Imagine that you had a client application that can only communicate using <b>basic http</b> and at the same time, you have a service that communicates using <b>net.tcp</b>. There are many ways to solve this problem. For example, with WCF you can have more than one endpoint for a service so it would be possible to expose an endpoint using <b>basicHttpBinding</b> for the client.</p>
        <p>With WCF4 <b>System.ServiceModel.Routing</b> you now have another way to solve this problem. In this exercise, you will use the routing service to bride the http and net.tcp protocol by simply configuring the routing service.</p>
        <a name="_Toc249317765" href="#">
          <span />
        </a>
        <a name="_Toc280957336" href="#">
          <span />
        </a>
        <p>
          <b>Task 0 – Opening the Solution</b>
        </p>
        <p>This exercise uses a new begin solution</p>
        <ol>
          <li>Open the starting solution for Exercise 8 located under the <b>Source\Ex8-ProtocolBridging\Begin (choosing the folder that matches the language of your preference.) </b>Use it as the starting point for this exercise.</li>
          <li>Press <b>CTRL+SHIFT+B</b> to build the solution.</li>
        </ol>
        <a name="_Toc249317766" href="#">
          <span />
        </a>
        <a name="_Toc280957337" href="#">
          <span />
        </a>
        <p>
          <b>Task 1 – Trying the Calculator</b>
        </p>
        <p>In this task, you will explore the calculator solution.</p>
        <ol>
          <li>The solution contains two projects a <b>CalculatorService</b> and <b>CalculatorClient</b> project.</li>
          <li>Open the app.config file from the CalculatorService project. Note the base address of the CalculatorService is using a net.tcp address.<div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>App.config</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;service name="CalculatorService.CalculatorService"&gt;  &lt;!-- ... --&gt;  &lt;host&gt;    &lt;baseAddresses&gt;      &lt;add baseAddress="net.tcp://localhost:9090/CalculatorService" /&gt;    &lt;/baseAddresses&gt;  &lt;/host&gt;</pre></td></tr></table></span></div><br /></li>
          <li>The <b>CalculatorClient</b> project has a Service Reference to the <b>CalculatorService</b> project. Open the app.config file for the <b>CalculatorClient</b> project, and note the client section is also using net.tcp to communicate with the calculator service.<div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>App.config</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;client&gt;  &lt;endpoint address="net.tcp://localhost:9090/CalculatorService"      binding="netTcpBinding" bindingConfiguration="CalculatorService"      contract="CalculatorServiceReference.ICalculatorService"       name="CalculatorService" /&gt;&lt;/client&gt;</pre></td></tr></table></span></div><br /></li>
          <li>The solution is set to use multiple startup projects. If this is not the case, right-click the solution node in <b>Solution Explorer</b>, and select <b>Set StartUp Projects</b> to configure them. Press <b>CTRL+F5</b> to start the solution. This will launch the <b>CalculatorService</b> and <b>CalculatorClient</b> applications.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> Windows Firewall may prompt you to allow the service access to use the network. It is safe to allow this.</td></tr></table><p /></div><br /></li>
          <li>The CalculatorClient will be pre-loaded with random values. Press <b>Invoke Service</b> to invoke the service over net.tcp. You will see something similar to the following.<p><img src="images\075e870b-e8ef-4a0f-a31c-2f0b9dd7f6fe.png" /></p><p><b>Figure 29</b><br /><i>The Calculator Service and Client Application connected over TCP</i></p><br /></li>
        </ol>
        <a name="_Toc249317767" href="#">
          <span />
        </a>
        <a name="_Toc280957338" href="#">
          <span />
        </a>
        <p>
          <b>Task 2 – Adding the Router Service</b>
        </p>
        <p>Your calculator works great if you are able to connect with net.tcp, but what if you had a requirement that the calculator application could access the calculator service over the Internet?</p>
        <p>In this task, you will change the CalculatorClient to connect to a router service bridging the http and net.tcp protocols.</p>
        <ol>
          <li>Right-click the <b>Ex8-ProtocolBriding</b> solution, point to <b>Add</b> and select <b>Existing Project</b>. Browse to <b>Source\Assets\RouterService (Choosing the folder that matches the language of your preference.)</b> and add the <b>RouterService</b> project.</li>
          <li>The routing service has to be configured Open the <b>Web.config</b> file from the <b>RouterService</b> project.</li>
          <li>The routing service is both a service and a client. The first thing you will do is add the client endpoint and binding configuration to the <b>Web.config</b> file. Add the following configuration as shown.<p><i>(Code Snippet - What is new in WCF4 Lab – RoutingService calc endpoint XML)</i></p><div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Web.config</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;system.serviceModel&gt;<b>  &lt;bindings&gt;</b><b>    &lt;netTcpBinding&gt;</b><b>      &lt;binding name="CalculatorService" &gt;</b><b>        &lt;security mode="None" /&gt;</b><b>      &lt;/binding&gt;</b><b>    &lt;/netTcpBinding&gt;</b><b>  &lt;/bindings&gt;</b><b>  &lt;client&gt;</b><b>    &lt;endpoint name="regularCalculatorEndpoint"</b><b>              address="net.tcp://localhost:9090/CalculatorService"</b><b>              binding="netTcpBinding"</b><b>              bindingConfiguration="CalculatorService"</b><b>              contract="*" /&gt;</b><b>  &lt;/client&gt;</b>&lt;/system.serviceModel&gt;</pre></td></tr></table></span></div><br /></li>
          <li>The routing service uses a filter table to map incoming messages to client endpoints. The next thing you need to do is to create the filter table and service behavior that will apply it in the configuration. To do this, add the following portion after the <b>client</b> section replacing the original <b>behaviors</b> node.<p><i>(Code Snippet - What is new in WCF4 Lab – Routing service behavior XML)</i></p><div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Web.config</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>  &lt;/client&gt;<b>  &lt;behaviors&gt;</b><b>    &lt;serviceBehaviors&gt;</b><b>      &lt;behavior name="routingConfiguration"&gt;</b><b>        &lt;routing filterTableName="filterTable1" /&gt;</b><b>        &lt;serviceDebug includeExceptionDetailInFaults="true"/&gt;</b><b>      &lt;/behavior&gt;</b><b>      &lt;behavior name=""&gt;</b><b>        &lt;serviceMetadata httpGetEnabled="true" /&gt;</b><b>        &lt;serviceDebug includeExceptionDetailInFaults="false" /&gt;</b><b>       &lt;/behavior&gt;</b><b>    &lt;/serviceBehaviors&gt;</b><b>  &lt;/behaviors&gt;</b><b>  &lt;routing&gt;</b><b>    &lt;filters&gt;</b><b>      &lt;filter name="MatchAllFilter" filterType="MatchAll" /&gt;</b><b>    &lt;/filters&gt;</b><b>    &lt;filterTables&gt;</b><b>      &lt;filterTable name="filterTable1"&gt;</b><b>        &lt;add filterName="MatchAllFilter"              endpointName="regularCalculatorEndpoint" priority="0"/&gt;</b><b>      &lt;/filterTable&gt;</b><b>    &lt;/filterTables&gt;</b><b>  &lt;/routing&gt;</b>&lt;/system.serviceModel&gt;</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td><img src="images\a3bea40e-50cf-4f71-b861-1d4932e073d8.png" /><b>What does the filter table do?</b><br />This filter table will match all requests and route them to the regularCalculatorEndpoint listening at <b>net.tcp://localhost:9090/CalculatorService</b>.</td></tr></table><p /></div><br /></li>
          <li>The last thing you need to do is to add a service definition for the router service. Your router service will be listening on http and routing requests to the calculator service, which is listening on net.tcp – this effectively bridges the protocols. Add the following configuration after the <b>routing</b> section.<p><i>(Code Snippet - What is new in WCF4 Lab – Routing service XML)</i></p><div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Web.config</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>  &lt;/routing&gt;<b>  &lt;services&gt;</b><b>    &lt;service behaviorConfiguration="routingConfiguration"</b><b>             name="System.ServiceModel.Routing.RoutingService"&gt;</b><b>      &lt;endpoint address="general"</b><b>                binding="basicHttpBinding"</b><b>                name="routerEndpoint1"</b><b>                contract="System.ServiceModel.Routing.IRequestReplyRouter" /&gt;</b><b>    &lt;/service&gt;</b><b>  &lt;/services&gt;</b>&lt;/system.serviceModel&gt;</pre></td></tr></table></span></div><br /></li>
        </ol>
        <a name="_Toc249317768" href="#">
          <span />
        </a>
        <a name="_Toc280957339" href="#">
          <span />
        </a>
        <p>
          <b>Task 3 – Modifying the Client to Enable Routed HTTP</b>
        </p>
        <ol>
          <li>Your client application will need a client endpoint definition to use with the router service. Open the <b>app.config</b> file from the <b>CalculatorClient</b> project, and add the following configuration after the existing endpoint.<p><i>(Code Snippet - What is new in WCF4 Lab – CalcClient endpoint XML)</i></p><div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>XML</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>  &lt;endpoint address="http://localhost:8000/Router.svc/general"</b><b>            binding="basicHttpBinding"</b><b>            contract="CalculatorServiceReference.ICalculatorService"</b><b>            name="RouterService" /&gt;</b>&lt;/client&gt;</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td><img src="images\e028ab84-e904-4dba-af09-6750414130c7.png" /><b>Named endpoints in configuration</b><br />If your client section contains more than one endpoint definition, you will have to provide an endpoint name when creating a client proxy. Look at the <b>CalculateResults</b> method of MainWindow, which has been written to pass the endpoint name to the proxy constructor.</td></tr></table><p /></div><br /></li>
        </ol>
        <h1 class="heading">Next Step</h1>
        <p>
          <a href="docSet_78d923cd-6081-4fb0-a0c5-5b9ef4f376ed.html">Exercise 8: Verification</a>
        </p>
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to VSKitFdbk@Microsoft.com<p />Copyright © 2011 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>