<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 7: Discovery Proxy" />
      <MSHelp:RLTitle Title="Exercise 7: Discovery Proxy" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 7: Discovery Proxy</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/script.js" type="text/javascript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">What's New in WCF 4?</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 7: Discovery Proxy</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
      <table width="100%" id="bottomTable" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <span onclick="ExpandCollapseAll(toggleAllImage)" onkeypress="ExpandCollapseAll_CheckKey(toggleAllImage)" tabindex="0" style="cursor:default;display:none;">
              <img id="toggleAllImage" class="toggleAll" alt="CollapseAll image" src="../local/collall.gif" />
              <label id="collapseAllLabel" for="toggleAllImage" style="display: none;">Collapse All</label>
              <label id="expandAllLabel" for="toggleAllImage" style="display: none;">Expand All</label> </span>
            <span id="languageFilterToolTip" onmouseover="languageFilterImage.src=dropDownHoverImage.src;" onmouseout="languageFilterImage.src=dropDownImage.src;" tabindex="0" style="cursor:default;">
              <img id="languageFilterImage" alt="DropDown image" src="../local/drpdown.gif" />
              <label id="showAllLabel" for="languageFilterImage" style="display: none;">Language Filter: All</label>
              <label id="multipleLabel" for="languageFilterImage" style="display: none;">Language Filter: Multiple</label>
              <label id="vbLabel" for="languageFilterImage" style="display: none;">Language Filter: Visual Basic</label>
              <label id="csLabel" for="languageFilterImage" style="display: none;">Language Filter: C#</label>
            </span>
          </td>
        </tr>
      </table>
      <div id="languageSpan">
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="vbUsageCheckbox" />
        <label class="languageFilter" for="vbUsageCheckbox">Visual Basic Usage</label>
        <br />
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="csCheckbox" />
        <label class="languageFilter" for="csCheckbox">C#</label>
        <br />
      </div>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>All the previous exercises have relied on a well-known UDP multicast endpoint for discovery. The port and multicast address are specified by the WS-Discovery protocol documentation. The utilization of this multicast discovery is referred to as ad hoc discovery. Ad hoc discovery is limited to recognizing only services on the same subnet. Managed discovery allows you to locate services no matter where they are, as long as they are registered with a discovery proxy. In this section of the lab, you will create a discovery proxy.</p>
        <p>The following diagram shows how a Discovery Proxy responds on behalf of the target services:</p>
        <p>
          <img src="images\eb2ccf14-ecdb-4e2b-b55d-244bdf7a4b91.png" />
        </p>
        <p>
          <b>Figure 18</b>
          <br />
          <i>Discovery Proxy used in service discovery</i>
        </p>
        <br />
        <div class="alert">
          <table width="100%" cellspacing="0" cellpadding="0">
            <tr>
              <th align="left">
                <img class="note" src="../local/note.gif" />Note:</th>
            </tr>
            <tr>
              <td>
                <img src="images\1ed0b5b0-c313-4a82-928b-b330de008931.png" />
                <b>Discovery Proxy</b>
                <br />For more information about Discovery Proxy and WS-Discovery message exchanges, see section 3 of the <a href="http://go.microsoft.com/fwlink/?LinkId=87841">WS-Discovery Specification</a>.</td>
            </tr>
          </table>
          <p />
        </div>
        <br />
        <a name="_Toc244159132" href="#">
          <span />
        </a>
        <a name="_Toc249317761" href="#">
          <span />
        </a>
        <a name="_Toc280957331" href="#">
          <span />
        </a>
        <p>
          <b>Task 0 – Opening the Solution</b>
        </p>
        <p>To begin this exercise, you can use the solution you finished from Exercise 6. Alternatively, you can follow the following steps to begin with Exercise 7.</p>
        <ol>
          <li>Open the starting solution for Exercise 7 located under the <b>Source\Ex7-DiscoveryProxy\Begin (choosing the folder that matches the language of your preference.) </b>Use it as the starting point for this exercise.</li>
          <li>Press <b>CTRL+SHIFT+B</b> to build the solution.</li>
        </ol>
        <a name="_Toc244159133" href="#">
          <span />
        </a>
        <a name="_Toc249317762" href="#">
          <span />
        </a>
        <a name="_Toc280957332" href="#">
          <span />
        </a>
        <p>
          <b>Task 1 – Creating a DiscoveryProxy</b>
        </p>
        <p>The<b> System.ServiceModel.Discovery</b> namespace includes a base class to help you in building your Discovery Proxy. To implement your proxy you will have to override a number of methods provided by the <b>System.ServiceModel.Discovery.<i>DiscoveryProxy</i></b> class. These methods are all asynchronous to guarantee maximum scalability for the server. For this Hands-on Lab, you will focus on supporting only Announcements in the proxy. When a chat client goes online or offline the cache of metadata will be updated. Then you will respond to find requests when a client wants to query the proxy for list of chat clients.</p>
        <ol>
          <li>Add a new <b>Console Application</b> project to the solution. To do this, in <b>Solution Explorer</b> right-click the <b>Begin</b> solution, point to <b>Add </b>and click <b>New Project</b>. Use the following settings.<table style=""><tr valign="top"><th><p>Setting</p></th><th><p>Value</p></th></tr><tr valign="top"><td><p>Language</p></td><td><p><b>Visual C# or Visual Basic</b></p></td></tr><tr valign="top"><td><p>Target Framework</p></td><td><p><b>.NET Framework 4</b></p></td></tr><tr valign="top"><td><p>Installed Templates</p></td><td><p><b>Windows</b></p></td></tr><tr valign="top"><td><p>Template</p></td><td><p><b>Console Application</b></p></td></tr><tr valign="top"><td><p>Name</p></td><td><p><b>ChatProxy</b></p></td></tr><tr valign="top"><td><p>Location</p></td><td><p><b>Source\Ex7-DiscoveryProxy\Begin</b></p></td></tr></table></li>
          <br />
          <p>
            <img src="images\95c95b91-6c91-4a38-9e61-e1717fd6a95b.png" />
          </p>
          <p>
            <b>Figure 19</b>
            <br />
            <i>Adding a new Console Application Project named “ChatProxy” (C#)</i>
          </p>
          <br />
          <p>
            <img src="images\a90f85d5-a083-4bd0-8ddd-276830b7c13a.png" />
          </p>
          <p>
            <b>Figure 20</b>
            <br />
            <i>Adding a new Console Application Project named “ChatProxy” (Visual Basic)</i>
          </p>
          <br />
          <li>Console applications use the .NET Framework Client Profile by default. To build a discovery proxy you need to change the target framework of the <b>ChatProxy</b> project to <b>.NET Framework 4</b>.<ol><li><b>C#</b>: In <b>Solution Explorer</b>,<b> </b>right-click the <b>ChatProxy</b> project, and select <b>Properties</b>. In the<b> Application</b> tab, change the target framework to <b>.NET Framework 4</b>. Visual Studio will warn you that it has to unload and reload the project before continuing.</li><li><b>Visual Basic</b>: In <b>Solution Explorer</b>,<b> </b>right-click the <b>ChatProxy</b> project and select <b>Properties</b>. In the <b>Compile</b> tab, click <b>Advance Compile Options</b> at the bottom and change the target framework to <b>.NET Framework 4</b>. Visual Studio will warn you that it has to unload and reload the project before continuing.</li></ol></li>
          <p>
            <img src="images\5aefe31e-7e38-405d-bce7-7ce06b237d65.png" />
          </p>
          <p>
            <b>Figure 21</b>
            <br />
            <i>Change to the full .NET Framework 4 Profile (C#)</i>
          </p>
          <br />
          <p>
            <img src="images\fc133341-4e66-4351-b8b5-1fcca2c4c229.png" />
          </p>
          <p>
            <b>Figure 22</b>
            <br />
            <i>Change to the full .NET Framework 4 Profile (Visual Basic)</i>
          </p>
          <br />
          <li>Right-click <b>ChatProxy</b> project, and click <b>Add Reference</b>. Using the <b>Projects</b> tab, add a project reference to the <b>DiscoveryChat</b> project. Repeat these steps, using the <b>.NET</b> tab to add a reference to the <b>System.ServiceModel</b> and <b>System.ServiceModel.Discovery</b> libraries.</li>
          <li>Press <b>CTRL+SHIFT+B</b> to build the solution.</li>
          <li>Your discovery proxy will need a class to implement the proxy service. Next step is to create the <b>ChatDiscoveryProxy</b> class. In <b>Solution Explorer</b>, right-click <b>ChatProxy</b> project, point to <b>Add</b>, and then click <b>Class</b>. Type<b> ChatDiscoveryProxy</b> in the <b>Name</b> box.<p><img src="images\33aca6d2-f3c8-49d4-9b47-af72ca3bbd1c.png" /></p><p><b>Figure 23</b><br /><i>Adding a new Class called  “ChatDiscoveryProxy” (C#)</i></p><br /><p><img src="images\d9a47460-1e15-4d05-a5ae-bfd26e6a7af2.png" /></p><p><b>Figure 24</b><br /><i>Adding a new Class called  “ChatDiscoveryProxy” (Visual Basic)</i></p><br /></li>
          <li>Add the following using directives for the new class.<p><i>(Code Snippet - What is new in WCF4 Lab – ChatDiscoveryProxy Using Statements CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>using System.ServiceModel;</b><b>using System.ServiceModel.Discovery;</b><b>using System.Collections.ObjectModel;</b><b>using Microsoft.Samples.Discovery.Contracts;</b></pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – ChatDiscoveryProxy Using Statements VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Imports System.ServiceModel</b><b>Imports System.ServiceModel.Discovery</b><b>Imports System.Collections.ObjectModel</b><b>Imports Microsoft.Samples.Discovery.Contracts</b></pre></td></tr></table></span></div><br /></li>
          <li>Make your class inherit from <b>System.ServiceModel.Discovery.<i>DiscoveryProxy</i></b> base class.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>public class ChatDiscoveryProxy : DiscoveryProxy</b></pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Public Class ChatDiscoveryProxy</b><b>    Inherits DiscoveryProxy</b></pre></td></tr></table></span></div><br /></li>
          <li>In this lab, your class will maintain a thread-safe in-memory cache. For this reason, you need to make your WCF service instance to be a singleton. In addition, because it is thread safe and you want to guarantee maximum scalability, you will also allow multiple concurrent calls. Modify the <b>ChatDiscoveryProxy</b> class signature, to add the following attributes.<p><i>(Code Snippet - What is new in WCF4 Lab – Proxy ServiceBehavior CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>[ServiceBehavior(</b><b>    InstanceContextMode = InstanceContextMode.Single, </b><b>    ConcurrencyMode = ConcurrencyMode.Multiple)]</b>public class ChatDiscoveryProxy : System.ServiceModel.Discovery.DiscoveryProxy</pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – Proxy ServiceBehavior VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>&lt;ServiceBehavior(InstanceContextMode:=InstanceContextMode.Single, ConcurrencyMode:=ConcurrencyMode.Multiple)&gt;</b>Public Class ChatDiscoveryProxy</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> Using an in-memory cache means that if your discovery proxy host shutdowns, all information regarding services is lost. More robust implementations would use durable storage, such as a database; this will insure that service metadata is not lost even when the service is down.</td></tr></table><p /></div><br /></li>
          <li>You will need to create a thread safe collection class to hold instances of services you have discovered. Right-click <b>ChatProxy</b> project, point to <b>Add</b>, and then click<b> Class</b>. Type<b> ChatServiceCollection</b> in the <b>Name</b> box.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>For more information see, <a href="http://msdn.microsoft.com/en-us/library/573ths2x(VS.71).aspx">Collections and Synchronization (Thread Safety)</a>.</td></tr></table><p /></div><br /></li>
          <li>Add the following using directives for the new class.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>using System.ServiceModel.Discovery;</b></pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Imports System.ServiceModel.Discovery</b></pre></td></tr></table></span></div><br /></li>
          <li>Mark your class as <b>internal</b> (C#) <b>friend</b> (Visual Basic), and make it inherit from the <b>SynchronizedKeyedCollection</b> base class.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>internal class ChatServiceCollection : SynchronizedKeyedCollection&lt;Uri, EndpointDiscoveryMetadata&gt;</b></pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Friend Class ChatServiceCollection</b><b>    Inherits SynchronizedKeyedCollection(Of Uri, EndpointDiscoveryMetadata)</b></pre></td></tr></table></span></div><br /></li>
          <li>Implement the <b>GetKeyForItem</b> method of the <b>SynchronizedKeyedCollection</b> class as shown in following code.<p><i>(Code Snippet - What is new in WCF4 Lab – GetKeyForItem Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>internal class ChatServiceCollection :     SynchronizedKeyedCollection&lt;Uri, EndpointDiscoveryMetadata&gt;{<b>protected override Uri GetKeyForItem(EndpointDiscoveryMetadata item)</b><b>    {</b><b>        if (item == null)</b><b>        {</b><b>            throw new ArgumentNullException("item");</b><b>        }</b><b>        return item.Address.Uri;</b><b>    }</b>}</pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – GetKeyForItem Method VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Friend Class ChatServiceCollection    Inherits SynchronizedKeyedCollection(Of Uri, EndpointDiscoveryMetadata)<b>    Protected Overrides Function GetKeyForItem(ByVal item As System.ServiceModel.Discovery.EndpointDiscoveryMetadata) As System.Uri</b><b>        If item Is Nothing Then</b><b>            Throw New ArgumentNullException("item")</b><b>        End If</b><b>        Return item.Address.Uri</b><b>    End Function</b>End Class</pre></td></tr></table></span></div><br /></li>
          <li>Switch back to the <b>ChatDiscoveryProxy</b> class implementation, and add a static <b>ChatServiceCollection</b> property and its backing field as shown in following code.<p><i>(Code Snippet - What is new in WCF4 Lab – ChatServiceCollection Member CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class ChatDiscoveryProxy : DiscoveryProxy{<b>    private static ChatServiceCollection cache = new ChatServiceCollection();</b><b>    internal static ChatServiceCollection Cache </b><b>    { </b><b>        get { return cache; } </b><b>    }</b>}</pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – ChatServiceCollection Member VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class ChatDiscoveryProxy    Inherits DiscoveryProxy<b>    Private Shared cache_Renamed As New ChatServiceCollection()</b><b>    Friend Shared ReadOnly Property Cache() As ChatServiceCollection</b><b>        Get</b><b>            Return cache_Renamed</b><b>        End Get</b><b>    End Property</b>End Class</pre></td></tr></table></span></div><br /></li>
          <li>To complete the service, you will add several helper classes, which are already developed for simplicity. To do this, right-click the <b>ChatProxy</b> project, point to <b>Add,</b> and click <b>Existing Item</b>. Then, browse to the <b>Source\Assets\ChatProxy</b><b>(choosing the folder that matches the language of your preference)</b> folder, and add the following files:<ol><li><b>AsyncResult.cs / AsyncResult.vb</b></li><li><b>CompletedAsyncResult.cs / CompletedAsyncResult.vb</b></li><li><b>FindAsyncResult.cs / FindAsyncResult.vb</b></li><li><b>EndpointDiscoveryMetadataExtensions.cs / EndpointDiscoveryMetadataExtensions.vb</b></li></ol></li>
          <li>When an online<b> </b>announcement is received, you need to determine if the service is one that you want to cache. If so, add it to your cache. Override the <b>OnBeginOnlineAnnouncement</b> method inside the <b>ChatDiscoveryProxy</b> class by adding the following code.<p><i>(Code Snippet - What is new in WCF4 Lab – OnBeginOnlineAnnouncement Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>protected override IAsyncResult OnBeginOnlineAnnouncement(DiscoveryMessageSequence messageSequence,</b><b>                                                EndpointDiscoveryMetadata endpointDiscoveryMetadata,</b><b>                                                AsyncCallback callback,</b><b>                                                object state)</b><b>{</b><b>    if (endpointDiscoveryMetadata == null)</b><b>    {</b><b>        throw new ArgumentNullException("endpointDiscoveryMetadata");</b><b>    }</b><b>    // You care only about ISimpleChatService services</b><b>    FindCriteria criteria = new FindCriteria(typeof(ISimpleChatService));</b><b>    if (criteria.IsMatch(endpointDiscoveryMetadata))</b><b>    {</b><b>        endpointDiscoveryMetadata.WriteLine("Adding");</b><b>        Cache.Add(endpointDiscoveryMetadata);</b><b>    }</b><b>    return new CompletedAsyncResult(callback, state);</b><b>}</b></pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – OnBeginOnlineAnnouncement Method VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Protected Overrides Function OnBeginOnlineAnnouncement(ByVal messageSequence As DiscoveryMessageSequence, ByVal endpointDiscoveryMetadata As EndpointDiscoveryMetadata, ByVal callback As AsyncCallback, ByVal state As Object) As IAsyncResult</b><b>    If endpointDiscoveryMetadata Is Nothing Then</b><b>        Throw New ArgumentNullException("endpointDiscoveryMetadata")</b><b>    End If</b><b>    ' You care only about ISimpleChatService services</b><b>    Dim criteria As New FindCriteria(GetType(ISimpleChatService))</b><b>    If criteria.IsMatch(endpointDiscoveryMetadata) Then</b><b>        endpointDiscoveryMetadata.WriteLine("Adding")</b><b>        Cache.Add(endpointDiscoveryMetadata)</b><b>    End If</b><b>    Return New CompletedAsyncResult(callback, state)</b><b>End Function</b></pre></td></tr></table></span></div><br /></li>
          <li>When an offline announcement message is received, you want to remove the metadata from the cache if it is there. Override the <b>OnBeginOfflineAnnouncement</b> method by adding the following code.<p><i>(Code Snippet - What is new in WCF4 Lab – OnBeginOfflineAnnouncement Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>protected override IAsyncResult OnBeginOfflineAnnouncement(DiscoveryMessageSequence messageSequence, EndpointDiscoveryMetadata endpointDiscoveryMetadata, AsyncCallback callback, object state)</b><b>{</b><b>    try</b><b>    {</b><b>        if (endpointDiscoveryMetadata == null)</b><b>        {</b><b>            throw new ArgumentNullException("endpointDiscoveryMetadata");</b><b>        }</b><b>        // You care only about ISimpleChatService services</b><b>        FindCriteria criteria = new FindCriteria(typeof(ISimpleChatService));</b><b>        if (criteria.IsMatch(endpointDiscoveryMetadata))</b><b>        {</b><b>            endpointDiscoveryMetadata.WriteLine("Removing");</b><b>            Cache.Remove(endpointDiscoveryMetadata.Address.Uri);</b><b>        }</b><b>    }</b><b>    catch (KeyNotFoundException)</b><b>    {</b><b>        // No problem if it does not exist in the cache</b><b>    }</b><b>    return new CompletedAsyncResult(callback, state);</b><b>}</b></pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – OnBeginOfflineAnnouncement Method VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Protected Overrides Function OnBeginOfflineAnnouncement(ByVal messageSequence As DiscoveryMessageSequence, ByVal endpointDiscoveryMetadata As EndpointDiscoveryMetadata, ByVal callback As AsyncCallback, ByVal state As Object) As IAsyncResult</b><b>    Try</b><b>        If endpointDiscoveryMetadata Is Nothing Then</b><b>            Throw New ArgumentNullException("endpointDiscoveryMetadata")</b><b>        End If</b><b>        ' You care only about ISimpleChatService services</b><b>        Dim criteria As New FindCriteria(GetType(ISimpleChatService))</b><b>        If criteria.IsMatch(endpointDiscoveryMetadata) Then</b><b>            endpointDiscoveryMetadata.WriteLine("Removing")</b><b>            Cache.Remove(endpointDiscoveryMetadata.Address.Uri)</b><b>        End If</b><b>    Catch e1 As KeyNotFoundException</b><b>        ' No problem if it does not exist in the cache</b><b>    End Try</b><b>    Return New CompletedAsyncResult(callback, state)</b><b>End Function</b></pre></td></tr></table></span></div><br /></li>
          <li>Now you can override the <b>OnBeginFind</b> method, which is called when a client issues a Discovery Find request to the proxy. Here is where you can search the cache of known service endpoints and reply to the client Find request with any matching endpoints.<p><i>(Code Snippet - What is new in WCF4 Lab – OnBeginFind Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>protected override IAsyncResult OnBeginFind(FindRequestContext findRequestContext, AsyncCallback callback, object state)</b><b>{</b><b>    if (findRequestContext == null)</b><b>    {</b><b>        throw new ArgumentNullException("findRequestContext");</b><b>    }</b><b>    Console.WriteLine(</b><b>        "Find request for contract {0}",</b><b>        findRequestContext.Criteria.ContractTypeNames.FirstOrDefault());</b><b>    // Query to find the matching endpoints</b><b>    var query = from service in Cache</b><b>                where findRequestContext.Criteria.IsMatch(service)</b><b>                select service;</b><b>    // Collection to contain the results of the query</b><b>    var matchingEndpoints = new Collection&lt;EndpointDiscoveryMetadata&gt;();</b><b>    // Execute the query and add the matching endpoints</b><b>    foreach (EndpointDiscoveryMetadata metadata in query)</b><b>    {</b><b>        metadata.WriteLine("\tFound");</b><b>        matchingEndpoints.Add(metadata);</b><b>        findRequestContext.AddMatchingEndpoint(metadata);</b><b>    }</b><b>    return new FindAsyncResult(matchingEndpoints, callback, state);</b><b>}</b></pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – OnBeginFind Method VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Protected Overrides Function OnBeginFind(ByVal findRequestContext As FindRequestContext, ByVal callback As AsyncCallback, ByVal state As Object) As IAsyncResult</b><b>    If findRequestContext Is Nothing Then</b><b>        Throw New ArgumentNullException("findRequestContext")</b><b>    End If</b><b>    Console.WriteLine("Find request for contract {0}", findRequestContext.Criteria.ContractTypeNames.FirstOrDefault())</b><b>    ' Query to find the matching endpoints</b><b>    Dim query = From service In Cache</b><b>                Where findRequestContext.Criteria.IsMatch(service)</b><b>                Select service</b><b>    ' Collection to contain the results of the query</b><b>    Dim matchingEndpoints = New Collection(Of EndpointDiscoveryMetadata)()</b><b>    ' Execute the query and add the matching endpoints</b><b>    For Each metadata As EndpointDiscoveryMetadata In query</b><b>        metadata.WriteLine(Constants.vbTab &amp; "Found")</b><b>        matchingEndpoints.Add(metadata)</b><b>        findRequestContext.AddMatchingEndpoint(metadata)</b><b>    Next metadata</b><b>    Return New FindAsyncResult(matchingEndpoints, callback, state)</b><b>End Function</b></pre></td></tr></table></span></div><br /></li>
          <li>Override the <b>OnEndFind</b> method to complete the find operation.<p><i>(Code Snippet - What is new in WCF4 Lab – OnEndFind Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>protected override void OnEndFind(IAsyncResult result)</b><b>{</b><b>    FindAsyncResult.End(result);</b><b>}</b></pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – OnEndFind Method VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Protected Overrides Sub OnEndFind(ByVal result As System.IAsyncResult)</b><b>    FindAsyncResult.End(result)</b><b>End Sub</b></pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>In this lab solution, the Discovery Proxy is implemented as a Console Application. Production environments would use a more robust hosting solution such as a Windows Service.</td></tr></table><p /></div><br /></li>
          <li>Override the rest of the required methods declared abstract in <b>System.ServiceModel.Discovery.<i>DiscoveryProxy</i></b>class.<p><i>(Code Snippet - What is new in WCF4 Lab – DiscoveryProxy Abstract Methods CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>protected override IAsyncResult OnBeginResolve(ResolveCriteria resolveCriteria, AsyncCallback callback, object state)</b><b>{</b><b>    return new CompletedAsyncResult(callback, state);</b><b>}</b><b>protected override EndpointDiscoveryMetadata OnEndResolve(IAsyncResult result)</b><b>{</b><b>    return CompletedAsyncResult&lt;EndpointDiscoveryMetadata&gt;.End(result);</b><b>}</b><b>protected override void OnEndOfflineAnnouncement(IAsyncResult result)</b><b>{</b><b>    CompletedAsyncResult.End(result);</b><b>}</b><b>protected override void OnEndOnlineAnnouncement(IAsyncResult result)</b><b>{</b><b>    CompletedAsyncResult.End(result);</b><b>}</b></pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – DiscoveryProxy Abstract Methods VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Protected Overrides Function OnBeginResolve(ByVal resolveCriteria As ResolveCriteria, ByVal callback As AsyncCallback, ByVal state As Object) As IAsyncResult</b><b>    Return New CompletedAsyncResult(callback, state)</b><b>End Function</b><b>Protected Overrides Function OnEndResolve(ByVal result As IAsyncResult) As EndpointDiscoveryMetadata</b><b>    Return CompletedAsyncResult(Of EndpointDiscoveryMetadata).End(result)</b><b>End Function</b><b>Protected Overrides Sub OnEndOfflineAnnouncement(ByVal result As IAsyncResult)</b><b>    CompletedAsyncResult.End(result)</b><b>End Sub</b><b>Protected Overrides Sub OnEndOnlineAnnouncement(ByVal result As IAsyncResult)</b><b>    CompletedAsyncResult.End(result)</b><b>End Sub</b></pre></td></tr></table></span></div><br /></li>
          <li>Now you need to modify the <b>Main</b> method to create a <b>ServiceHost</b> for your <b>ChatDiscoveryProxy</b> service. To do this, open <b>Program.cs (C#)</b> or<b> Module1.vb (Visual Basic)</b> in the <b>ChatProxy</b> project.</li>
          <li>Add the following using directives to <b>Program.cs (C#)</b> or<b> Module1.vb (Visual Basic)</b>.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>using System.Net;</b><b>using System.ServiceModel;</b><b>using System.ServiceModel.Discovery;</b></pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Imports System.Net</b><b>Imports System.ServiceModel</b><b>Imports System.ServiceModel.Discovery</b></pre></td></tr></table></span></div><br /></li>
          <li>For hosting the <b>ChatDiscoveryProxy</b> service, you will create the <b>DiscoveryEndpoint</b> endpoint for the service host. Add the following method inside the <b>Program</b> class (C#) or the <b>Module1</b> module (Visual Basic).<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td><b>Note: </b>In this lab solution, you will be using TCP port 8001 for your proxy service.</td></tr></table><p /></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – HostDiscoveryEndpoint Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>private static ServiceHost HostDiscoveryEndpoint(string hostName)</b><b>{</b><b>    // Create a new ServiceHost with a singleton ChatDiscovery Proxy</b><b>    ServiceHost myProxyHost = new</b><b>        ServiceHost(new ChatDiscoveryProxy());</b><b>    string proxyAddress = "net.tcp://" +</b><b>        hostName + ":8001/discoveryproxy";</b><b>    // Create the discovery endpoint</b><b>    DiscoveryEndpoint discoveryEndpoint =</b><b>        new DiscoveryEndpoint(</b><b>            new NetTcpBinding(),</b><b>            new EndpointAddress(proxyAddress));</b><b>    discoveryEndpoint.IsSystemEndpoint = false;</b><b>    // Add UDP Annoucement endpoint</b><b>    myProxyHost.AddServiceEndpoint(new UdpAnnouncementEndpoint());</b><b>    // Add the discovery endpoint</b><b>    myProxyHost.AddServiceEndpoint(discoveryEndpoint);</b><b>    myProxyHost.Open();</b><b>    Console.WriteLine("Discovery Proxy {0}",</b><b>        proxyAddress);</b><b>    return myProxyHost;</b><b>}</b></pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – HostDiscoveryEndpoint Method VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Private Function HostDiscoveryEndpoint(ByVal hostName As String) As ServiceHost</b><b>    ' Create a new ServiceHost with a singleton ChatDiscovery Proxy</b><b>    Dim myProxyHost As New ServiceHost(New ChatDiscoveryProxy())</b><b>    Dim proxyAddress As String = "net.tcp://" &amp; hostName &amp; ":8001/discoveryproxy"</b><b>    ' Create the discovery endpoint</b><b>    Dim discoveryEndpoint As New DiscoveryEndpoint(New NetTcpBinding(), New EndpointAddress(proxyAddress))</b><b>    discoveryEndpoint.IsSystemEndpoint = False</b><b>    ' Add UDP Annoucement endpoint</b><b>    myProxyHost.AddServiceEndpoint(New UdpAnnouncementEndpoint())</b><b>    ' Add the discovery endpoint</b><b>    myProxyHost.AddServiceEndpoint(discoveryEndpoint)</b><b>    myProxyHost.Open()</b><b>    Console.WriteLine("Discovery Proxy {0}", proxyAddress)</b><b>    Return myProxyHost</b><b>End Function</b></pre></td></tr></table></span></div><br /></li>
          <li>Modify the <b>Main</b> method as shown in the following code, to host the <b>ChatDiscoveryProxy</b> service.<p><i>(Code Snippet - What is new in WCF4 Lab – DiscoveryProxy Main Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>static void Main(string[] args){<b>    Console.Title = "ChatProxy Service";</b><b>    Console.WriteLine("ChatProxy Console Host");</b><b>    string hostName = Dns.GetHostName();</b><b>    using (ServiceHost proxyHost = HostDiscoveryEndpoint(hostName))</b><b>    {</b><b>        Console.WriteLine("Press &lt;Enter&gt; to exit");</b><b>        Console.ReadLine();</b><b>        proxyHost.Close();</b><b>    }</b>}</pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – DiscoveryProxy Main Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Sub Main()<b>    Console.Title = "ChatProxy Service"</b><b>    Console.WriteLine("ChatProxy Console Host")</b><b>    Dim hostName As String = Dns.GetHostName()</b><b>    Using proxyHost As ServiceHost = HostDiscoveryEndpoint(hostName)</b><b>        Console.WriteLine("Press &lt;Enter&gt; to exit")</b><b>        Console.ReadLine()</b><b>        proxyHost.Close()</b><b>    End Using</b>End Sub</pre></td></tr></table></span></div><br /></li>
          <li>Press <b>CTRL+SHIFT+B</b> to build the solution.</li>
        </ol>
        <a name="_Toc244159134" href="#">
          <span />
        </a>
        <a name="_Toc249317763" href="#">
          <span />
        </a>
        <a name="_Toc280957333" href="#">
          <span />
        </a>
        <p>
          <b>Task 2 – Modifying the DiscoveryChat Application to use Managed Discovery</b>
        </p>
        <p>Now that you have implemented a discovery proxy, you need to modify the chat application to make use of it.</p>
        <ol>
          <li>Open the <b>SimpleChat</b> form in code view from the <b>DiscoveryChat</b> project. You can open the code view by selecting the file and pressing <b>F7</b>.</li>
          <li>Locate the <b>ManagedDiscovery</b> method. The UI is already calling this method if the Managed Discovery radio button is checked. As you have already implemented the handlers for ad hoc discovery, the only thing pending is to add code to implement this managed discovery as shown in the following code.<p><i>(Code Snippet - What is new in WCF4 Lab – ManagedDiscovery Method CSharp)</i></p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>private void ManagedDiscovery(){<b>    try</b><b>    {</b><b>        // Create an endpoint for the proxy</b><b>        DiscoveryEndpoint proxyEndpoint =</b><b>            new DiscoveryEndpoint(</b><b>                new NetTcpBinding(),</b><b>                new EndpointAddress(proxyAddressText.Text));</b><b>        // Create the DiscoveryClient with a proxy endpoint </b><b>        // for managed discovery</b><b>        this.discoveryClient = new DiscoveryClient(proxyEndpoint);</b><b>        // Same handlers as ad hoc discovery</b><b>        this.discoveryClient.FindCompleted +=</b><b>            new EventHandler&lt;FindCompletedEventArgs&gt;(this.OnFindCompleted);</b><b>        this.discoveryClient.FindProgressChanged +=</b><b>            new EventHandler&lt;FindProgressChangedEventArgs&gt;(this.OnFindProgressChanged);</b><b>        // Setup the form for discovery</b><b>        this.ShowDiscoveryInProgress(true);</b><b>        this.discoveryClient.FindAsync(new FindCriteria(typeof(ISimpleChatService)));</b><b>    }</b><b>    catch (UriFormatException)</b><b>    {</b><b>        MessageBox.Show(</b><b>            Resources.InvalidUriMessage,</b><b>            this.Text,</b><b>            MessageBoxButtons.OK,</b><b>            MessageBoxIcon.Information,</b><b>            MessageBoxDefaultButton.Button1,</b><b>            (MessageBoxOptions)0);</b><b>    }</b>}</pre></td></tr></table></span></div><br /><p><i>(Code Snippet - What is new in WCF4 Lab – ManagedDiscovery Method VB)</i></p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Private Sub ManagedDiscovery()<b>    Try</b><b>        ' Create an endpoint for the proxy</b><b>        Dim proxyEndpoint As New DiscoveryEndpoint(New NetTcpBinding(), New EndpointAddress(proxyAddressText.Text))</b><b>        ' Create the DiscoveryClient with a proxy endpoint </b><b>        ' for managed discovery</b><b>        Me._discoveryClient = New DiscoveryClient(proxyEndpoint)</b><b>        ' Same handlers as ad hoc discovery</b><b>        AddHandler _discoveryClient.FindCompleted, AddressOf OnFindCompleted</b><b>        AddHandler _discoveryClient.FindProgressChanged, AddressOf OnFindProgressChanged</b><b>        ' Setup the form for discovery</b><b>        Me.ShowDiscoveryInProgress(True)</b><b>        Me._discoveryClient.FindAsync(New FindCriteria(GetType(ISimpleChatService)))</b><b>    Catch e1 As UriFormatException</b><b>        MessageBox.Show(My.Resources.InvalidUriMessage, Me.Text, MessageBoxButtons.OK, MessageBoxIcon.Information, MessageBoxDefaultButton.Button1, CType(0, MessageBoxOptions))</b><b>    End Try</b>End Sub</pre></td></tr></table></span></div><br /></li>
          <li>Locate the <b>InitializeManagedDiscovery</b> method, and set the managed radio button <i>Checked</i> property to <b>True</b>.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>private void InitializeManagedDiscovery(){<b>    this.managedRadioButton.Checked = true;</b>}</pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Private Sub InitializeManagedDiscovery()<b>    Me.managedRadioButton.Checked = True</b>End Sub</pre></td></tr></table></span></div><br /></li>
          <li>Press <b>CTRL+SHIFT+B</b> to build the solution.</li>
        </ol>
        <h1 class="heading">Next Step</h1>
        <p>
          <a href="docSet_2edf96f1-bac4-4978-90af-e751235641e0.html">Exercise 7: Verification</a>
        </p>
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to VSKitFdbk@Microsoft.com<p />Copyright © 2011 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>