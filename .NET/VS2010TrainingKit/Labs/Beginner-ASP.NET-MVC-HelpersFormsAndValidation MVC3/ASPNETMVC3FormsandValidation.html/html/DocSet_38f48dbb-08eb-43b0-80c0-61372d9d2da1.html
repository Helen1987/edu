<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 6: Adding Validation" />
      <MSHelp:RLTitle Title="Exercise 6: Adding Validation" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 6: Adding Validation</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/script.js" type="text/javascript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">ASP.NET MVC 3 Helpers, Forms and Validation</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 6: Adding Validation</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
      <table width="100%" id="bottomTable" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <span onclick="ExpandCollapseAll(toggleAllImage)" onkeypress="ExpandCollapseAll_CheckKey(toggleAllImage)" tabindex="0" style="cursor:default;display:none;">
              <img id="toggleAllImage" class="toggleAll" alt="CollapseAll image" src="../local/collall.gif" />
              <label id="collapseAllLabel" for="toggleAllImage" style="display: none;">Collapse All</label>
              <label id="expandAllLabel" for="toggleAllImage" style="display: none;">Expand All</label> </span>
            <span id="languageFilterToolTip" onmouseover="languageFilterImage.src=dropDownHoverImage.src;" onmouseout="languageFilterImage.src=dropDownImage.src;" tabindex="0" style="cursor:default;">
              <img id="languageFilterImage" alt="DropDown image" src="../local/drpdown.gif" />
              <label id="showAllLabel" for="languageFilterImage" style="display: none;">Language Filter: All</label>
              <label id="multipleLabel" for="languageFilterImage" style="display: none;">Language Filter: Multiple</label>
              <label id="vbLabel" for="languageFilterImage" style="display: none;">Language Filter: Visual Basic</label>
              <label id="csLabel" for="languageFilterImage" style="display: none;">Language Filter: C#</label>
            </span>
          </td>
        </tr>
      </table>
      <div id="languageSpan">
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="vbUsageCheckbox" />
        <label class="languageFilter" for="vbUsageCheckbox">Visual Basic Usage</label>
        <br />
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="csCheckbox" />
        <label class="languageFilter" for="csCheckbox">C#</label>
        <br />
      </div>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>Currently, the Create and Edit forms you have in place do not perform any kind of validation. If the user leaves a required field blank or type letters in the price field, the first error you will get will be from the database.</p>
        <p>You can add validation to the application by adding Data Annotations to your model class. Data Annotations allow describing the rules you want applied to your model properties, and ASP.NET MVC will take care of enforcing and displaying appropriate message to users.</p>
        <p>Additionally, you will add client-side (AJAX) validation that will check all fields in the browser before being submitted to the controller actions.</p>
        <br />
        <a name="_Toc282517439" href="#">
          <span />
        </a>
        <p>
          <b>Task 1 – Adding Data Annotations</b>
        </p>
        <p>In this task, you will add Data Annotations to the Album Model that will make the Create and Edit page display validation messages when appropriate.</p>
        <ol>
          <li>Start Microsoft Visual Web Developer 2010 Express from <b>Start</b> | <b>All Programs</b> | <b>Microsoft Visual Studio 2010 Express </b>| <b>Microsoft Visual Web Developer 2010 Express</b>. </li>
          <li>In the <b>File</b> menu, choose <b>Open Project</b>. In the Open Project dialog, browse to <b>Source\Ex06-AddingValidation\Begin</b>, select <b>MvcMusicStore.sln</b> and click <b>Open</b>.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> For a simple Model class, adding a Data Annotation is just handled by adding a <b>using</b> statement for <b>System.ComponentModel.DataAnnotation</b>, then placing a <b>[Required]</b> attribute on the appropriate properties.<br />The following example would make the <b>Name</b> property a required field in the View.<br /><br /><b>using System.ComponentModel.DataAnnotations;</b><br /><b>namespace SuperheroSample.Models</b><br /><b>{</b><br /><b>    public class Superhero</b><br /><b>    {</b><br /><b>        [Required]</b><br /><b>        public string Name { get; set; }</b><br /><b>        public bool WearsCape { get; set; }</b><br /><b>    }</b><br /><b>}</b><br /><br />This is a little more complex in cases like this application where the Entity Data Model is generated. If you added Data Annotations directly to the model classes, they would be overwritten if you update the model from the database.<br />Instead, you can make use of metadata partial classes which will exist to hold the annotations and are associated with the model classes using the <b>[MetadataType]</b> attribute.</td></tr></table><p /></div><br /></li>
          <li>Add a new metadata partial class. To do this, right-click the <b>Models</b> folder within the Solution Explorer, select <b>Add</b> and then <b>New Item</b>.</li>
          <li>In the <b>Add New Item</b> dialog, select the <b>Class</b> template, located under <b>Visual C# -&gt; Web</b> template list. Change the name to <b>Album.cs</b> and click <b>Add</b>.<p><img src="images\e51ff24d-664e-4cbe-81e4-c6df10229660.png" /></p><p><b>Figure 32</b><br /><i>Adding Album.cs</i></p><br /></li>
          <li>Replace <b>Album.cs</b> content with the highlighted code, so that it looks like the following:<p>(Code Snippet – ASP.NET MVC 3 Helpers and Forms and Validation – Ex6 Album metadata partial class – CSharp)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>using System;using System.Collections.Generic;using System.Linq;using System.Web;<b>using System.ComponentModel;</b><b>using System.ComponentModel.DataAnnotations;</b><b>using System.Web.Mvc;</b><b>namespace MvcMusicStore.Models</b><b>{</b><b>    [MetadataType(typeof(AlbumMetaData))]</b><b>    public partial class Album</b><b>    {</b><b>        // Validation rules for the Album class</b><b>        [Bind(Exclude = "AlbumId")]</b><b>        public class AlbumMetaData</b><b>        {</b><b>            [ScaffoldColumn(false)]</b><b>            public object AlbumId { get; set; }</b><b>            [DisplayName("Genre")]</b><b>            public object GenreId { get; set; }</b><b>            [DisplayName("Artist")]</b><b>            public object ArtistId { get; set; }</b><b>            [Required(ErrorMessage = "An Album Title is required")]</b><b>            [DisplayFormat(ConvertEmptyStringToNull =false)]</b><b>            [StringLength(160)]</b><b>            public object Title { get; set; }</b><b>            [DisplayName("Album Art URL")]</b><b>            [StringLength(1024)]</b><b>            public object AlbumArtUrl { get; set; }</b><b>            [Required(ErrorMessage = "Price is required")]</b><b>            [Range(0.01, 100.00, ErrorMessage = "Price must be between 0.01 and 100.00")]</b><b>            public object Price { get; set; }</b><b>        }</b><b>    }</b><b>}</b></pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>This <b>Album</b> partial class has a <b>MetadataType</b> attribute which points to the <b>AlbumMetaData</b> class for the Data Annotations. These are some of the Data Annotation attributes you are using to annotate the Album model:<br />•  Required – Indicates that the property is a required field<br />•  DisplayName – Defines the text to be used on form fields and validation messages<br />•  DisplayFormat – Specifies how data fields are displayed and formatted.<br />•  StringLength – Defines a maximum length for a string field<br />•  Range – Gives a maximum and minimum value for a numeric field<br />•  Bind – Lists fields to exclude or include when binding parameter or form values to model properties<br />•  ScaffoldColumn – Allows hiding fields from editor forms</td></tr></table><p /></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td> The line <b>[DisplayFormat(ConvertEmptyStringToNull=false)]</b> indicates that empty strings from the model won’t be converted to null when the data field is updated in the data source. This setting will avoid an exception when the Entity Framework assigns null values to the model before Data Annotation validates the fields.</td></tr></table><p /></div><br /></li>
        </ol>
        <a name="_Toc282517440" href="#">
          <span />
        </a>
        <p>
          <b>Task 2 – Running the Application</b>
        </p>
        <p>In this task, you will test that the Create and Edit pages validate fields, using the display names chosen in the last task.</p>
        <ol>
          <li>Press <b>F5</b> to run the Application.</li>
          <li>The project starts in the Home page. Change the URL to <b>/StoreManager/Create</b>.  Verify that the display names match the ones in the partial class (like <b>Album Art URL</b> instead of <b>AlbumArtUrl</b>)</li>
          <li>Click <b>Save</b>, without filling the form. Verify that you get the corresponding validation messages.<p><img src="images\4a51fa06-e992-4ce7-90e8-92ee45e02a35.png" /></p><p><b>Figure 33</b><br /><i>Validated fields in Create page</i></p><br /></li>
          <li>You can verify that the same occurs with the <b>Edit</b> page. Change the URL to <b>/StoreManager/Edit/388</b> and verify that the display names match the ones in the partial class (like <b>Album Art URL</b> instead of <b>AlbumArtUrl</b>). Empty the <b>Title</b> and <b>Price</b> fields and click <b>Save</b>. Verify that you get the corresponding validation messages.<p><img src="images\bdcb1206-2b9a-4945-aa28-8009a9469f3d.png" /></p><p><b>Figure 34</b><br /><i>Validated fields in Edit page</i></p><br /></li>
        </ol>
        <a name="_Toc282517441" href="#">
          <span />
        </a>
        <p>
          <b>Task 3 – Adding Client-Side (AJAX) validation</b>
        </p>
        <p>In this task, you will add client-side (AJAX) validation to the forms to check all fields in the browser before being submitted to the controller actions.</p>
        <ol>
          <li>Close the browser if needed, to return to the Visual Studio window.  Open <b>/Views/Shared/EditorTemplates/Album.ascx</b></li>
          <li>Include the needed references to the libraries that will take care of the client-side validation:<div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>HTML</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;%@ Control Language="C#" Inherits="System.Web.Mvc.ViewUserControl&lt;MvcMusicStore.Models.Album&gt;" %&gt;<b>&lt;script src="/Scripts/MicrosoftAjax.js" type="text/javascript"&gt;&lt;/script&gt;</b><b>&lt;script src="/Scripts/MicrosoftMvcAjax.js" type="text/javascript"&gt;&lt;/script&gt;</b><b>&lt;script src="/Scripts/MicrosoftMvcValidation.js" type="text/javascript"&gt;&lt;/script&gt;</b></pre></td></tr></table></span></div><br /></li>
          <li>Use the <b>Html.EnableClientValidation</b> helper method to turn on client-side validation. For both the <b>Create</b> and <b>Edit</b> view templates, add that call directly above the <b>Html.BeginForm</b> call. In order to do that, open <b>/Views/StoreManager/Create.aspx</b> and <b>/Views/StoreManager/Edit.aspx</b> and add the following:<p>(Code Snippet – ASP.NET MVC 3 Helpers and Forms and Validation – Ex6 Client-Side validation – CSharp)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>    &lt;% Html.EnableClientValidation(); %&gt;</b>    &lt;% using (Html.BeginForm()) {%&gt;        &lt;%: Html.ValidationSummary(true) %&gt;        &lt;fieldset&gt;</pre></td></tr></table></span></div><br /></li>
          <li>Edit the <b>Web.config</b> in the project root to disable UnobtrusiveJavaScript. To do this, replace the appSettings entry with the following one:<div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>XML</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;configuration&gt;  &lt;appSettings&gt;    &lt;add key="ClientValidationEnabled" value="true"/&gt;     &lt;add key="UnobtrusiveJavaScriptEnabled" value="false"/&gt;   &lt;/appSettings&gt;</pre></td></tr></table></span></div><br /></li>
        </ol>
        <a name="_Toc282517442" href="#">
          <span />
        </a>
        <p>
          <b>Task 4 – Running the Application</b>
        </p>
        <p>In this task, you will test that the Create and Edit pages validate fields in the browser before being submitted to the controller actions.</p>
        <ol>
          <li>Press <b>F5</b> to run the Application.</li>
          <li>The project starts in the Home page. Change the URL to <b>/StoreManager/Create</b>.  Enter a letter in the <b>Price</b> field and click anywhere else in the form, taking focus out of the text box. Verify that without submitting the form, the corresponding validation message appears.<p><img src="images\d4e8c015-8d31-41d3-9bf7-370406d3e1cf.png" /></p><p><b>Figure 35</b><br /><i>Validated fields at client-side</i></p><br /></li>
          <li>Delete the letter entered in the <b>Price</b> field and verify that the appropriate validation message appears without submitting the form.<p><img src="images\2c1151c9-9c2d-4f11-93cc-5c0b973dee69.png" /></p><p><b>Figure 36</b><br /><i>Validated fields at client-side</i></p><br /></li>
        </ol>
        <h1 class="heading">Next Step</h1>
        <p>
          <a href="docSet_9ba5f87a-1c96-4f09-b58c-6866b88351ff.html">Summary</a>
        </p>
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to VSKitFdbk@Microsoft.com<p />Copyright © 2011 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>