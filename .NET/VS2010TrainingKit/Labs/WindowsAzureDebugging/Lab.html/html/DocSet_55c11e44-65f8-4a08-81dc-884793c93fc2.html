<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 1: Debugging an Application in the Cloud" />
      <MSHelp:RLTitle Title="Exercise 1: Debugging an Application in the Cloud" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 1: Debugging an Application in the Cloud</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/script.js" type="text/javascript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">Debugging Applications in Windows Azure</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 1: Debugging an Application in the Cloud</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
      <table width="100%" id="bottomTable" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <span onclick="ExpandCollapseAll(toggleAllImage)" onkeypress="ExpandCollapseAll_CheckKey(toggleAllImage)" tabindex="0" style="cursor:default;display:none;">
              <img id="toggleAllImage" class="toggleAll" alt="CollapseAll image" src="../local/collall.gif" />
              <label id="collapseAllLabel" for="toggleAllImage" style="display: none;">Collapse All</label>
              <label id="expandAllLabel" for="toggleAllImage" style="display: none;">Expand All</label> </span>
            <span id="languageFilterToolTip" onmouseover="languageFilterImage.src=dropDownHoverImage.src;" onmouseout="languageFilterImage.src=dropDownImage.src;" tabindex="0" style="cursor:default;">
              <img id="languageFilterImage" alt="DropDown image" src="../local/drpdown.gif" />
              <label id="showAllLabel" for="languageFilterImage" style="display: none;">Language Filter: All</label>
              <label id="multipleLabel" for="languageFilterImage" style="display: none;">Language Filter: Multiple</label>
              <label id="vbLabel" for="languageFilterImage" style="display: none;">Language Filter: Visual Basic</label>
              <label id="csLabel" for="languageFilterImage" style="display: none;">Language Filter: C#</label>
            </span>
          </td>
        </tr>
      </table>
      <div id="languageSpan">
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="vbUsageCheckbox" />
        <label class="languageFilter" for="vbUsageCheckbox">Visual Basic Usage</label>
        <br />
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="csCheckbox" />
        <label class="languageFilter" for="csCheckbox">C#</label>
        <br />
      </div>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>Because Windows Azure Diagnostics is oriented towards operational monitoring and has to cater for gathering information from multiple role instances, it requires that diagnostic data first be transferred from local storage in each role to Windows Azure storage, where it is aggregated. This requires programming scheduled transfers with the diagnostic monitor to copy logging data to Windows Azure storage at regular intervals, or else requesting a transfer of the logs on-demand. Moreover, information obtained in this manner provides a snapshot of the diagnostics data available at the time of the transfer. To retrieve updated data, a new transfer is necessary. When debugging a single role, and especially during the development phase, these actions add unnecessary friction to the process. To simplify the retrieval of diagnostics data from a deployed role, it is simpler to read information directly from Windows Azure storage, without requiring additional steps. </p>
        <p>In this exercise, you debug a simple application by configuring a special trace listener that can write its output directly into a table in Windows Azure storage emulator.  To produce diagnostic data, you instrument the application to write its trace information using standard methods in the System.Diagnostics namespace. Finally, you create a simple log viewer application that can retrieve and display the contents of the diagnostics table.</p>
        <p>The application that you will use for this exercise simulates an online auto insurance policy calculator. It has a single form where users can enter details about their vehicle and then submit the form to obtain an estimate on their insurance premium. Behind the scenes, the controller action that processes the form uses a separate assembly to calculate premiums based on the input from the user. The assembly contains a bug that causes it to raise an exception for input values that fall outside the expected range. </p>
        <br />
        <a name="_Toc280113408" href="#">
          <span />
        </a>
        <p>
          <b>Task 1 – Exploring the Fabrikam Insurance Application</b>
        </p>
        <p>In this task, you build and run the Fabrikam Insurance application in the Web Development Server to become familiar with its operation. </p>
        <ol>
          <li>Open Visual Studio<b> </b>in elevated administrator mode from<b> Start | All Programs | Microsoft Visual Studio 2010 </b>by right clicking the <b>Microsoft Visual Studio 2010 </b>shortcut and choosing <b>Run as administrator</b>. </li>
          <li>If the <b>User Account Control</b> dialog appears, click <b>Continue</b>.</li>
          <li>In the <b>File</b> menu, choose <b>Open</b> and then <b>Project/Solution</b>. In the <b>Open Project</b> dialog, browse to <b>Ex1-LoggingToAzureStorage</b> in the <b>Source</b> folder of the lab and choose the folder for the language of your preference (Visual C# or Visual Basic). Select <b>Begin.sln</b> in the <b>Begin</b> folder and then click <b>Open</b>. </li>
          <li>Set the start action of the project. To do this, in <b>Solution Explorer</b>, right-click the <b>FabrikamInsurance</b> project and then select <b>Properties</b>. In the properties window, switch to the <b>Web</b> tab and then, under <b>Start Action</b>, select the <b>Specific Page</b> option. Leave the page value blank.<p><img src="images\95fb59a9-ec8a-4f73-8df2-886fd216491b.png" /></p><p><b>Figure 1</b><br /><i>Configuring the start action of the project</i></p><br /></li>
          <li>Press <b>F5</b> to build and run the solution. The application should launch in the Web Development Server and open its <b>Auto Insurance Quotes</b> page in your browser.</li>
          <li>To explore its operation, complete the form by choosing any combination of values from the <b>Vehicle Details</b> drop down lists and then click <b>Calculate</b> to obtain a quote for the insurance premium. Notice that after you submit the form, the page refreshes and shows the calculated amount.<p><img src="images\f00af1ea-e63a-4496-a014-b37307d3549c.png" /></p><p><b>Figure 2</b><br /><i>Exploring the Fabrikam Insurance application</i></p><br /></li>
          <li>Press <b>SHIFT + F5</b> to stop debugging and shut down the application.</li>
        </ol>
        <br />
        <a name="_Toc280113409" href="#">
          <span />
        </a>
        <p>
          <b>Task 2 – Running the Application as a Windows Azure Project</b>
        </p>
        <p>In this task, you create a new Windows Azure Project to prepare the application for deployment to Windows Azure.</p>
        <ol>
          <li>Add a new Windows Azure Project to the solution. To do this, in the<b> File </b>menu, point to <b>Add</b> and then select <b>New Project</b>. In the <b>Add</b><b>New Project</b> dialog, expand the language of your preference (Visual C# or Visual Basic) in the <b>Installed Templates</b> list and then select <b>Cloud</b>. Choose the <b>Windows Azure Project</b> template, set the <b>Name</b> of the project to <b>FabrikamInsuranceService</b> and accept the proposed location in the folder of the solution. Click <b>OK</b> to create the project.<p><img src="images\dcc6bfc5-f22d-40d1-a166-7ec672c8fe57.png" /></p><p><b>Figure 3</b><br /><i>Creating a new Windows Azure Project (C#)</i></p><br /><p><img src="images\b6766a36-0943-4b2b-b421-6009e53957b0.png" /></p><p><b>Figure 4</b><br /><i>Creating a new Windows Azure Project (Visual Basic)</i></p><br /></li>
          <li>In the <b>New Windows Azure Project</b> dialog, click <b>OK</b> without adding any new roles to the solution.</li>
          <li>Now, in <b>Solution Explorer</b>, right-click the <b>Roles</b> node in the new <b>FabrikamInsuranceService</b> project, point to <b>Add</b>, and then select <b>Web Role Project in solution</b>. Then, in the <b>Associate with Role Project</b> dialog, select the <b>FabrikamInsurance</b> project, and click <b>OK</b>.<p><img src="images\d675a723-77dd-44f2-82f4-7dedb838a64f.png" /></p><p><b>Figure 5</b><br /><i>Associating the MVC application with the Windows Azure Project</i></p><br /></li>
          <li>Add references to the Windows Azure support assemblies. To do this, in <b>Solution Explorer</b>, right-click the <b>FabrikamInsurance</b> project, and then select <b>Add Reference</b>. In the <b>Add Reference</b> dialog, switch to the <b>.NET</b> tab, select the <b>Microsoft.WindowsAzure.Diagnostics</b>, <b>Microsoft.WindowsAzure.ServiceRuntime</b>, and <b>Microsoft.WindowsAzure.StorageClient</b> components, and then click <b>OK</b>.<p><img src="images\ad4dd2d3-ce3e-49ca-a887-aaeb8841e02e.png" /></p><p><b>Figure 6</b><br /><i>Adding references to the Windows Azure support assemblies to the project</i></p><br /></li>
          <li>Now, add a role entry point to the MVC application. To do this, in <b>Solution Explorer</b>, right-click the <b>FabrikamInsurance</b> project, point to <b>Add</b>, and then select <b>Existing Item</b>. In the <b>Add Existing Item</b> dialog, browse to <b>Assets</b> in the <b>Source</b> folder of the lab. Inside this folder, choose the folder for the language of your project (Visual C# or Visual Basic), select <b>WebRole.cs</b> or <b>WebRole.vb</b>, and then click <b>Add</b>.<div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>WebRole</b> class is a <b>RoleEntryPoint</b> derived class that contains methods that Windows Azure calls when it starts, runs, or stops the role. The provided code is the same that Visual Studio generates when you create a new Windows Azure Project.</td></tr></table><p /></div><br /></li>
          <li>You are now ready to test the Windows Azure Project application. To launch the application in the compute emulator, press <b>F5</b>. Wait until the deployment completes and the browser opens to show its main page.</li>
          <li>Again, complete the entry form by choosing a combination of values from the drop down lists and then click <b>Calculate</b>. Ensure that you receive a valid response with the calculated premium as a result.</li>
          <li>Once you have verified that everything works in the compute emulator just as it did when hosted by the Web Development Server, you will now cause an exception by making the application process bad data that it does not handle correctly. To do this, change the values used for the calculation by setting the <b>Make</b> to “<i>PORSCHE”</i> and the <b>Model</b> to “<i>BOXSTER (BAD DATA)”</i>.<p><img src="images\7cd188df-d718-4a6a-ba2f-ec407d00c70b.png" /></p><p><b>Figure 7</b><br /><i>Choosing make and model for the insurance premium calculation</i></p><br /></li>
          <li>Click <b>Calculate</b> to re-submit the form with new values. Notice that an unhandled exception occurs and execution halts in the Visual Studio debugger at the line that caused the error. <p><img src="images\b4543242-78b7-4397-bcd2-2f8b9ccdd5d0.png" /></p><p><b>Figure 8</b><br /><i>Unhandled exception in the application caused by bad data</i></p><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>Within the Visual Studio debugger, you are able to step through code, set breakpoints, and examine the value of program variables. Debugging applications hosted in the compute emulator provides the same experience that you typically have when debugging other programs to which you can attach the Visual Studio debugger. Using the debugger under these conditions is covered extensively and will not be explored here. For more information, see <a href="http://msdn.microsoft.com/en-us/library/sc65sadd.aspx">Debugging in Visual Studio</a>.</td></tr></table><p /></div><br /></li>
          <li>Press <b>F5</b> to continue execution and let ASP.NET handle the exception. Notice that the unhandled exception handler provides details about the exception, including the line in the source code that raised the exception. <p><img src="images\771a983a-91bd-4294-940e-0ddf22dac670.png" /></p><p><b>Figure 9</b><br /><i>ASP.NET default unhandled exception handler </i></p><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>Unhandled exceptions are typically handled by ASP.NET, which can report the error in its response including details about an error and the location in the source code where the exception was raised. However, for applications that are available publicly, exposing such information is not recommended to prevent unnecessary disclosure of internal details about the application that may compromise its security. Instead, errors and other diagnostics output should be written to a log that can only be retrieved after proper authorization.<br />You can configure how information is displayed by ASP.NET when an unhandled error occurs during the execution of a Web request.<b> </b>For more information, see <a href="http://msdn.microsoft.com/en-us/library/h0hfz6fc.aspx">customErrors Element (ASP.NET Settings Schema)</a>.<br />In this case, the unhandled exception error page includes full details for the error because the default mode for the <b>customErrors</b> element is <i>remoteOnly</i> and you are accessing the page locally. When you deploy the application to the cloud and access it remotely, the page shows a generic error message instead.</td></tr></table><p /></div><br /></li>
          <li>Press <b>SHIFT + F5</b> to stop debugging and shut down the application.</li>
        </ol>
        <br />
        <a name="_Toc280113410" href="#">
          <span />
        </a>
        <p>
          <b>Task 3 – Adding Tracing Support to the Application</b>
        </p>
        <p>In the previous task, you briefly saw how to debug your application with Visual Studio when it executes locally in the compute emulator. To debug the application once you deploy it to the cloud, you need to write debugging information to the logs in order to diagnose an application failure. </p>
        <p>In this task, you add a TraceListener to the project capable of logging diagnostics data directly into table storage, where you can easily retrieve it with a simple query. The source code for this project is already provided for you in the <b>Assets</b> folder of the lab. More information on the Trace Listener can be found here: <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.tracelistener.aspx">http://msdn.microsoft.com/en-us/library/system.diagnostics.tracelistener.aspx</a></p>
        <ol>
          <li>In <b>Solution Explorer</b>, right-click the <b>Begin</b> solution, point to <b>Add</b> and then select <b>Existing Project</b>. In the <b>Add Existing Project</b> dialog, browse to <b>Assets</b> in the <b>Source</b> folder of the lab, select the folder for the language of your choice (Visual C# or Visual Basic), then navigate to <b>AzureDiagnostics</b> inside this folder, select the <b>AzureDiagnostics</b> project file and click <b>Open</b>.</li>
          <li>Add a reference to the <b>AzureDiagnostics</b> library in the web role project. To do this, in <b>Solution Explorer</b>, right-click the <b>FabrikamInsurance</b> project, and select <b>Add Reference</b>. In the <b>Add Reference</b> dialog, switch to the <b>Projects</b> tab, select <b>AzureDiagnostics</b> in the list of projects, and then click <b>OK</b>.</li>
          <li>Open <b>Global.asax.cs</b> (for Visual C# projects) or <b>Global.asax.vb</b> (for Visual Basic projects) in the <b>FabrikamInsurance</b> project and insert the following namespace directives.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>using Microsoft.WindowsAzure;</b><b>using Microsoft.WindowsAzure.ServiceRuntime;</b></pre></td></tr></table></span></div></li>
          <br />
          <div class="code">
            <span codeLanguage="VisualBasicUsage">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <th>VB</th>
                  <th>
                    <span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0">
                      <img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span>
                  </th>
                </tr>
                <tr>
                  <td colspan="2">
                    <pre><b>Imports Microsoft.WindowsAzure</b><b>Imports Microsoft.WindowsAzure.ServiceRuntime</b></pre>
                  </td>
                </tr>
              </table>
            </span>
          </div>
          <br />
          <li>Add the following (highlighted) method inside the <b>MvcApplication</b> class.<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-ConfigureTraceListener-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class MvcApplication : System.Web.HttpApplication{  ...<b>  private static void ConfigureTraceListener()</b><b>  {</b><b>    bool enableTraceListener = false;</b><b>    string enableTraceListenerSetting = RoleEnvironment.GetConfigurationSettingValue("EnableTableStorageTraceListener");</b><b>    if (bool.TryParse(enableTraceListenerSetting, out enableTraceListener))</b><b>    {</b><b>      if (enableTraceListener)</b><b>      {</b><b>        AzureDiagnostics.TableStorageTraceListener listener =</b><b>            new AzureDiagnostics.TableStorageTraceListener("Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString")</b><b>        {</b><b>          Name = "TableStorageTraceListener"</b><b>        };</b><b>        System.Diagnostics.Trace.Listeners.Add(listener);</b><b>        System.Diagnostics.Trace.AutoFlush = true;</b><b>      }</b><b>      else</b><b>      {</b><b>        System.Diagnostics.Trace.Listeners.Remove("TableStorageTraceListener");</b><b>      }</b><b>    }</b><b>  }</b>}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-ConfigureTraceListener-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class MvcApplication  Inherits System.Web.HttpApplication  ...<b>  Private Shared Sub ConfigureTraceListener()</b><b>    Dim enableTraceListener As Boolean = False</b><b>    Dim enableTraceListenerSetting As String = RoleEnvironment.GetConfigurationSettingValue("EnableTableStorageTraceListener")</b><b>    If Boolean.TryParse(enableTraceListenerSetting, enableTraceListener) Then</b><b>      If enableTraceListener Then</b><b>        Dim listener As New AzureDiagnostics.TableStorageTraceListener("Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString") With {.Name = "TableStorageTraceListener"}</b><b>        System.Diagnostics.Trace.Listeners.Add(listener)</b><b>        System.Diagnostics.Trace.AutoFlush = True</b><b>      Else</b><b>        System.Diagnostics.Trace.Listeners.Remove("TableStorageTraceListener")</b><b>      End If</b><b>    End If</b><b>  End Sub</b>End Class</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>ConfigureTraceListener</b> method retrieves the <i>EnableTableStorageTraceListener</i> configuration setting and, if its value is <i>true</i>, it creates a new instance of the <b>TableStorageTraceListener</b> class, defined in the project that you added to the solution earlier, and then adds it to the collection of available trace listeners. Note that the method also enables the <b>AutoFlush</b> property of the <b>Trace</b> object to ensure that trace messages are written immediately to table storage, allowing you to retrieve them as they occur.</td></tr></table><p /></div><br /></li>
          <li>Now, insert the following (highlighted) code in the <b>Application_Start</b> method to set up the Windows Azure storage configuration settings publisher and to enable the <b>TableStorageTraceListener</b>. <p>(Code Snippet – <i>WindowsAzureDebugging-Ex1- Application_Start-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class MvcApplication : System.Web.HttpApplication{  ...  protected void Application_Start()  {<b>    CloudStorageAccount.SetConfigurationSettingPublisher((configName, configSetter) =&gt;</b><b>    {</b><b>        configSetter(RoleEnvironment.GetConfigurationSettingValue(configName));</b><b>    });</b><b>    ConfigureTraceListener();</b>    AreaRegistration.RegisterAllAreas();    RegisterRoutes(RouteTable.Routes);  }  ...}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-Application_Start-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class MvcApplication  Inherits System.Web.HttpApplication  ...  Sub Application_Start()<b>    CloudStorageAccount.SetConfigurationSettingPublisher(Sub(configName, configSetter) configSetter(RoleEnvironment.GetConfigurationSettingValue(configName)))</b><b>    ConfigureTraceListener()</b>    AreaRegistration.RegisterAllAreas()    RegisterRoutes(RouteTable.Routes)   End Sub  ...End Class</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>TraceListeners can be added by configuring them in the <b>system.diagnostics</b> section of the configuration file. However, in this case, the role creates the listener programmatically allowing you to enable the listener only when you need it and while the service is running.</td></tr></table><p /></div><br /><p><img src="images\64fd547f-4ffb-46fd-8abc-ae63e6b1a756.png" /></p><p><b>Figure 10</b><br /><i>Enabling the TableStorageTraceListener in the configuration file</i></p><br /></li>
          <li>Next, define a configuration setting to control the diagnostics logging with the <b>TableStorageTraceListener</b>. To create the setting, expand the Roles node in the <b>FabrikamInsuranceService</b> project and then double-click the <b>FabrikamInsurance</b> role. In the role properties window, switch to the <b>Settings</b> page, click <b>Add Setting</b>, and then set the name of the new setting to <i>EnableTableStorageTraceListener</i>, the type as <i>String</i>, and the value as <i>false</i>.<p><img src="images\22c7f632-f33c-4d0c-9509-58577ab21dcc.png" /></p><p><b>Figure 11</b><br /><i>Creating a configuration setting to enable the trace listener</i></p><br /></li>
          <li>Locate the <b>RoleEnvironmentChanging</b> event handler inside the <b>WebRole</b> class and replace its body with the following (highlighted) code.<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-WebRole RoleEnvironmentChanging event handler-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class WebRole : RoleEntryPoint{  ...  private void RoleEnvironmentChanging(object sender, RoleEnvironmentChangingEventArgs e)  {<b>    // for any configuration setting change except EnableTableStorageTraceListener</b><b>    if (e.Changes.OfType&lt;RoleEnvironmentConfigurationSettingChange&gt;().Any(change =&gt; change.ConfigurationSettingName != "EnableTableStorageTraceListener"))</b><b>    {</b><b>      // Set e.Cancel to true to restart this role instance</b><b>      e.Cancel = true;</b><b>    }</b>  }  ...}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-WebRole RoleEnvironmentChanging event handler-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class WebRole  Inherits RoleEntryPoint  ...  Private Sub RoleEnvironmentChanging(ByVal sender As Object, ByVal e As RoleEnvironmentChangingEventArgs)<b>    ' for any configuration setting change except EnableTableStorageTraceListener</b><b>    If e.Changes.OfType(Of RoleEnvironmentConfigurationSettingChange)().Any(Function(change) change.ConfigurationSettingName &lt;&gt; "EnableTableStorageTraceListener") Then</b><b>      ' Set e.Cancel to true to restart this role instance</b><b>      e.Cancel = True</b><b>    End If</b>  End Sub  ...End Class</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>RoleEnvironmentChanging</b> event occurs before a change to the service configuration is applied to the running instances of the role. The updated handler scans the collection of changes and restarts the role instance for any configuration setting change, unless the change only involves the value of the <i>EnableTableStorageTraceListener</i> setting.  If this particular setting changes, the role instance is allowed to apply the change without restarting it.</td></tr></table><p /></div><br /></li>
          <li>Now, add the following (highlighted) code to define a handler for the <b>RoleEnvironmentChanged</b> event into the <b>Global.asax.cs</b> (for Visual C# projects) or <b>Global.asax.vb</b> (for Visual Basic projects).<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-Global RoleEnvironmentChanged event handler-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class MvcApplication : System.Web.HttpApplication{  ...<b>  private void RoleEnvironmentChanged(object sender, RoleEnvironmentChangedEventArgs e)</b><b>  {</b><b>    // configure trace listener for any changes to EnableTableStorageTraceListener </b><b>    if (e.Changes.OfType&lt;RoleEnvironmentConfigurationSettingChange&gt;().Any(change =&gt; change.ConfigurationSettingName == "EnableTableStorageTraceListener"))</b><b>    {</b><b>      ConfigureTraceListener();</b><b>    }</b><b>  }</b>  ...}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-Global RoleEnvironmentChanged event handler-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class MvcApplication  Inherits System.Web.HttpApplication  ...<b>  Private Sub RoleEnvironmentChanged(ByVal sender As Object, ByVal e As RoleEnvironmentChangedEventArgs)</b><b>    ' configure trace listener for any changes to EnableTableStorageTraceListener </b><b>    If e.Changes.OfType(Of RoleEnvironmentConfigurationSettingChange)().Any(Function(change) change.ConfigurationSettingName = "EnableTableStorageTraceListener") Then</b><b>      ConfigureTraceListener()</b><b>    End If</b><b>  End Sub</b>  ...End Class</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>RoleEnvironmentChanged</b> event handler occurs after a change to the service configuration has been applied to the running instances of the role. If this change involves the <i>EnableTableStorageTraceListener</i> configuration setting, the handler calls the <b>ConfigureTraceListener</b> method to enable or disable the trace listener.</td></tr></table><p /></div><br /></li>
          <li>Finally, insert the following (highlighted) line into the <b>Application_Start</b> method, immediately after to the call to the <b>ConfigureTraceListener</b> method, to subscribe to the <b>Changed</b> event of the <b>RoleEnvironment</b>.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class MvcApplication : System.Web.HttpApplication{  ...  protected void Application_Start()  {     CloudStorageAccount.SetConfigurationSettingPublisher((configName, configSetter) =&gt;    {      configSetter(RoleEnvironment.GetConfigurationSettingValue(configName));    });    ConfigureTraceListener();<b>    RoleEnvironment.Changed += RoleEnvironmentChanged;</b>    AreaRegistration.RegisterAllAreas();    RegisterRoutes(RouteTable.Routes);  }  ...}</pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class MvcApplication  Inherits System.Web.HttpApplication  ...  Sub Application_Start()    CloudStorageAccount.SetConfigurationSettingPublisher(Sub(configName, configSetter) configSetter(RoleEnvironment.GetConfigurationSettingValue(configName)))    ConfigureTraceListener()<b>    AddHandler RoleEnvironment.Changed, AddressOf RoleEnvironmentChanged</b>    AreaRegistration.RegisterAllAreas()    RegisterRoutes(RouteTable.Routes)  End Sub  ...End Class</pre></td></tr></table></span></div><br /></li>
          <li>To instrument the application and write diagnostics information to the error log, add a global error handler to the application. To do this, insert the following method into the <b>MVCApplication</b> class.<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-Application_Error-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class MvcApplication : System.Web.HttpApplication{  ...<b>  protected void Application_Error()</b><b>  {</b><b>    var lastError = Server.GetLastError();</b><b>    System.Diagnostics.Trace.TraceError(lastError.Message);</b><b>  }</b>}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-Application_Error-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class MvcApplication  Inherits System.Web.HttpApplication  ...<b>  Protected Sub Application_Error()</b><b>    Dim lastError = Server.GetLastError()</b><b>    System.Diagnostics.Trace.TraceError(lastError.Message)</b><b>  End Sub</b>End Class</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>Application_Error</b> event is raised to catch any unhandled ASP.NET errors while processing a request. The event handler shown above retrieves a reference to the unhandled exception object using <b>Server.GetLastError</b> and then uses the <b>TraceError</b> method of the <b>System.Diagnostics.Trace</b> class to log the error message. <br />Note that the <b>Trace</b> object outputs the message to each listener in its <b>Listeners</b> collection, including the <b>TableStorageTraceListener</b>, provided you enable it in the configuration settings. Typically, the collection also contains instances of the <b>DefaultTraceListener</b> class and, when executing the solution in the compute emulator, the <b>DevelopmentFabricTraceListener</b>.  The latter writes its output to a log that you can view from the Compute Emulator UI.<br />To write to the Windows Azure diagnostics log, a <b>DiagnosticMonitorTraceListener</b> can also be added to the <b>Web.config</b> or <b>App.config</b> file of the role. When using this type of trace listener, the logs are gathered locally in each role. To retrieve them, you first need to instruct the diagnostic monitor to copy the information to storage services. The role project templates included with the Windows Azure Tools for Microsoft Visual Studio already include the settings required to use the <b>DiagnosticMonitorTraceListener</b> in the configuration files it generates.</td></tr></table><p /></div><br /><p><img src="images\6df3c27d-8591-45fc-98e4-c047b5beb1b2.png" /></p><p><b>Figure 12</b><br /><i>Trace object Listeners collection showing configured trace listeners</i></p><br /></li>
          <li>Open the <b>QuoteController.cs</b> (for Visual C# projects) or <b>QuoteController.vb</b> (for Visual Basic projects) file in the <b>Controllers</b> folder of the <b>FabrikamInsurance</b> project and add the following method. <p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-Controller OnException method-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>[HandleError]public class QuoteController : Controller{  ...<b>  protected override void OnException(ExceptionContext filterContext)</b><b>  {</b><b>    System.Diagnostics.Trace.TraceError(filterContext.Exception.Message);</b><b>  }</b>}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-Controller OnException method-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;HandleError()&gt;Public Class QuoteController  Inherits Controller  ...<b>  Protected Overrides Sub OnException(ByVal filterContext As ExceptionContext)</b><b>    System.Diagnostics.Trace.TraceError(filterContext.Exception.Message)</b><b>  End Sub</b>End Class</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The <b>OnException</b> method is called when an unhandled exception occurs during the processing of an action in a controller. For MVC applications, unhandled errors are typically caught at the controller level, provided they occur during the execution of a controller action and that the action (or controller) has been decorated with a <b>HandleErrorAttribute</b>. To log exceptions in controller actions, you need to override the <b>OnException</b> method of the controller because the <b>Application_Error</b> is bypassed when the error-handling filter catches the exceptions. <br />By default, when an action method with the <b>HandleErrorAttribute</b> attribute throws any exception, MVC displays the <b>Error</b> view that is located in the <b>~/Views/Shared</b> folder.</td></tr></table><p /></div><br /></li>
          <li>In addition to error logging, tracing can also be useful for recording other significant events during the execution of the application. For example, for registering whenever a given controller action is invoked. To show this feature, insert the following (highlighted) tracing statement at the start of the <b>Calculator</b> method to log a message whenever this action is called. <div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class QuoteController : Controller{  ...  public ActionResult Calculator()  {<b>    System.Diagnostics.Trace.TraceInformation("Calculator called...");</b>    QuoteViewModel model = new QuoteViewModel();    PopulateViewModel(model, null);    return View(model);  }  ...}</pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class QuoteController  Inherits Controller  ...  Public Function Calculator() As ActionResult<b>    System.Diagnostics.Trace.TraceInformation("Calculator called...")</b>    Dim model As New QuoteViewModel()    PopulateViewModel(model, Nothing)    Return View(model)  End Function  ...End Class</pre></td></tr></table></span></div><br /></li>
          <li>Similarly, add a tracing statement to the <b>About</b> action, as shown (highlighted) below.<div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class QuoteController : Controller{  ...  public ActionResult About()  {<b>    System.Diagnostics.Trace.TraceInformation("About called...");</b>    return View();  }  ...}</pre></td></tr></table></span></div><br /><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class QuoteController  Inherits Controller  ...  Public Function About() As ActionResult<b>    System.Diagnostics.Trace.TraceInformation("About called...")</b>    Return View()  End Function  ...End Class</pre></td></tr></table></span></div></li>
        </ol>
        <br />
        <a name="_Toc280113411" href="#">
          <span />
        </a>
        <p>
          <b>Task 4 – Creating a Log Viewer Tool</b>
        </p>
        <p>At this point, the application is ready for tracing and can send all its diagnostics output to a table in storage services. To view the trace logs, you now create a simple log viewer application that will periodically query the table and retrieve all entries added since it was last queried.</p>
        <ol>
          <li>Add a new console application project to the solution. To create the project, in the <b>File</b> menu, point to <b>Add</b>, and then select <b>New Project</b>. In the <b>Add New Project</b> dialog, expand node for the language of your choice (Visual C# or Visual Basic) in the <b>Installed Templates</b> tree view, select the <b>Windows</b> category, and then the <b>Console Application</b> template. Set the name of the project to <b>LogViewer</b>, accept the proposed location inside the solution folder, and then click <b>OK</b>.</li>
          <li>Right-click the new <b>LogViewer</b> project in <b>Solution Explorer</b> and select <b>Properties</b>. <p><b>For Visual C# projects</b>: </p><p>In the properties window, switch to the <b>Application</b> page, and then change the <b>Target framework</b> to <i>.NET Framework 4</i>.</p><p><img src="images\94c41054-4b60-4979-9077-ca512c1ef6c3.png" /></p><p><b>Figure 13</b><br /><i>Configuring the target framework for the project (Visual C#)</i></p><br /><p><b>For Visual Basic projects:</b></p><p>In the properties window, switch to the <b>Compile</b> page and then click <b>Advanced Compile Options</b>. In the <b>Advanced Compiler Settings</b> dialog, select <i>.NET Framework 4</i> in the <b>Target framework</b> drop down list, and then click <b>OK</b>.</p><p><img src="images\5f2b0e53-374c-4f77-aeea-f5e6cf64adc9.png" /></p><p><b>Figure 14</b><br /><i>Configuring the target framework for the project (Visual Basic)</i></p><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The client profile is not suitable in this case because the application will use the StorageClient API to retrieve log data from table storage. This API relies on functionality available only in the full .NET Framework 4 distribution.</td></tr></table><p /></div><br /></li>
          <li>If the <b>Target Framework Change</b> dialog appears, click <b>Yes</b>.<p><img src="images\d5fdc13a-bfb2-495e-b1b6-dc5768c3cbb7.png" /></p><p><b>Figure 1</b><br /><i>Target Framework Change</i></p><br /></li>
          <li>Add references to the assemblies required by this project. To do this, in <b>Solution Explorer</b>, right-click the <b>LogViewer</b> project and select <b>Add Reference</b>. In the <b>Add Reference</b> dialog, switch to the <b>.NET</b> tab and, while holding down the <b>CTRL</b> key to select multiple items, select <b>System.Configuration</b>, <b>Microsoft.WindowsAzure.StorageClient</b>, and <b>System.Data.Services.Client</b>, and then click <b>OK</b>.</li>
          <li>Next, add a reference to the diagnostics project in the solution. Repeat the previous step to open the <b>Add Reference</b> dialog, only this time select the <b>Projects</b> tab, select the <b>AzureDiagnostics</b> project and click <b>OK</b>.</li>
          <li>Add a class to display a simple progress indicator in the console window to the project. To do this, in <b>Solution Explorer</b>, right-click <b>LogViewer</b>, point to <b>Add</b>, and select<b> Existing Item</b>. In the <b>Add Existing Item</b> dialog, browse to <b>Assets</b> in the <b>Source</b> folder of the lab, select the folder for the language of the project (Visual C# or Visual Basic), select the <b>ProgressIndicator.[cs|.vb]</b> file, and then click <b>Add</b>.</li>
          <li>In <b>Solution Explorer</b>, double-click <b>Program.cs</b> or <b>Module1.vb</b> to open this file and insert the following namespace declarations at the top of the file.<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-LogViewer namespaces-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>using System.Configuration;</b><b>using System.Data.Services.Client;</b><b>using System.Threading;</b><b>using Microsoft.WindowsAzure;</b><b>using Microsoft.WindowsAzure.StorageClient;</b><b>using AzureDiagnostics;</b></pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-LogViewer namespaces-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Imports System.Configuration</b><b>Imports System.Data.Services.Client</b><b>Imports System.Threading</b><b>Imports Microsoft.WindowsAzure</b><b>Imports Microsoft.WindowsAzure.StorageClient</b><b>Imports AzureDiagnostics</b></pre></td></tr></table></span></div><br /></li>
          <li>For Visual Basic projects only, reformulate the <b>Sub Main</b> making it <b>Public</b> and adding a string array parameter named <b>args</b>.<div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Module Module1<b>  Public Sub Main(ByVal args() As String)</b>  End SubEnd Module</pre></td></tr></table></span></div><br /></li>
          <li>Define the following (highlighted) members in the <b>Program</b> class (for Visual C# projects) or the <b>Module1</b> module (for Visual Basic projects).<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-LogViewer static members-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>class Program{<b>  private static string lastPartitionKey = String.Empty;</b><b>  private static string lastRowKey = String.Empty;</b>  static void Main(string[] args)  {  }}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-LogViewer static members-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Module Module1<b>  Private lastPartitionKey As String = String.Empty</b><b>  Private lastRowKey As String = String.Empty</b>  Public Sub Main(ByVal args() As String)  End SubEnd Module</pre></td></tr></table></span></div><br /></li>
          <li>Next, insert the <b>QueryLogTable</b> method into the class or module.<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-QueryLogTable method-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>class Program{  ...<b>  private static void QueryLogTable(CloudTableClient tableStorage)</b><b>  {</b><b>    TableServiceContext context = tableStorage.GetDataServiceContext();</b><b>    DataServiceQuery query = context.CreateQuery&lt;LogEntry&gt;(TableStorageTraceListener.DIAGNOSTICS_TABLE)</b><b>                                    .Where(entry =&gt; entry.PartitionKey.CompareTo(lastPartitionKey) &gt; 0</b><b>                                        || (entry.PartitionKey == lastPartitionKey &amp;&amp; entry.RowKey.CompareTo(lastRowKey) &gt; 0))</b><b>                                        as DataServiceQuery;</b><b>    foreach (AzureDiagnostics.LogEntry entry in query.Execute())</b><b>    {</b><b>      Console.WriteLine("{0} - {1}", entry.Timestamp, entry.Message);</b><b>      lastPartitionKey = entry.PartitionKey;</b><b>      lastRowKey = entry.RowKey;</b><b>    }</b><b>  }</b>  ...}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-QueryLogTable method-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Module Module1  ...<b>  Private Sub QueryLogTable(ByVal tableStorage As CloudTableClient)</b><b>    Dim context As TableServiceContext = tableStorage.GetDataServiceContext()</b><b>    Dim query As DataServiceQuery = TryCast(context.CreateQuery(Of LogEntry)(TableStorageTraceListener.DIAGNOSTICS_TABLE).Where(Function(entry) entry.PartitionKey.CompareTo(lastPartitionKey) &gt; 0 OrElse (entry.PartitionKey = lastPartitionKey AndAlso entry.RowKey.CompareTo(lastRowKey) &gt; 0)), DataServiceQuery)</b><b>    For Each entry As AzureDiagnostics.LogEntry In query.Execute()</b><b>      Console.WriteLine("{0} - {1}", entry.Timestamp, entry.Message)</b><b>      lastPartitionKey = entry.PartitionKey</b><b>      lastRowKey = entry.RowKey</b><b>    Next</b><b>  End Sub</b>  ...End Module</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The rows in the diagnostic log table are stored with a primary key composed by the partition and row key properties, where both are based on the event tick count of the corresponding log entry and are thus ordered chronologically. The <b>QueryLogTable</b> method queries the table to retrieve all rows whose primary key value is greater than the last value obtained during the previous invocation of this method. This ensures that each time it is called, the method only retrieves new entries added to the log.</td></tr></table><p /></div><br /></li>
          <li>Finally, to complete the changes, insert the following (highlighted) code into the body of method <b>Main</b>.<p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-LogViewer Main method-CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>class Program{  ...  static void Main(string[] args)  {<b>    string connectionString = (args.Length == 0) ? "Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString" : args[0];</b><b>    CloudStorageAccount account = CloudStorageAccount.Parse(ConfigurationManager.AppSettings[connectionString]);</b><b>    CloudTableClient tableStorage = account.CreateCloudTableClient();</b><b>    tableStorage.CreateTableIfNotExist(TableStorageTraceListener.DIAGNOSTICS_TABLE);</b><b>    Utils.ProgressIndicator progress = new Utils.ProgressIndicator();</b><b>    Timer timer = new Timer((state) =&gt;</b><b>    {</b><b>      progress.Disable();</b><b>      QueryLogTable(tableStorage);</b><b>      progress.Enable();</b><b>    }, null, 0, 10000);</b><b>    Console.ReadKey(true);</b>  }}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>WindowsAzureDebugging-Ex1-LogViewer Main method-VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Module Module1  ...  Public Sub Main(ByVal args() As String)<b>    Dim connectionString As String = If((args.Length = 0), "Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString", args(0))</b><b>    Dim account As CloudStorageAccount = CloudStorageAccount.Parse(ConfigurationManager.AppSettings(connectionString))</b><b>    Dim tableStorage As CloudTableClient = account.CreateCloudTableClient()</b><b>    tableStorage.CreateTableIfNotExist(TableStorageTraceListener.DIAGNOSTICS_TABLE)</b><b>    Dim progress As New ProgressIndicator()</b><b>    Dim timer As New Timer(Sub(state)</b><b>                             progress.Disable()</b><b>                             QueryLogTable(tableStorage)</b><b>                             progress.Enable()</b><b>                           End Sub, Nothing, 0, 10000)</b><b>    Console.ReadKey(True)</b>  End SubEnd Module</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>The inserted code initializes the Windows Azure storage account information, creates the diagnostics table if necessary, and then starts a timer that periodically calls the <b>QueryLogMethod</b> defined in the previous step to display new entries in the diagnostics log.</td></tr></table><p /></div><br /></li>
          <li>To complete the viewer application, open the <b>App.config</b> file in the <b>LogViewer</b> project and insert the following (highlighted) <b>appSettings</b> section to define the <i>DiagnosticsConnectionString</i> setting required to initialize the storage account information.<p>(Code Snippet – <i>WindowsAzureDebugging-LogViewer DiagnosticConnectionString</i>)</p><div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>XML</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;configuration&gt;  ...<b>  &lt;appSettings&gt;</b><b>    &lt;add key="Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString" value="UseDevelopmentStorage=true"/&gt;</b><b>  &lt;/appSettings&gt;</b>  &lt;startup&gt;    &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.0" /&gt;  &lt;/startup&gt;&lt;/configuration&gt;</pre></td></tr></table></span></div></li>
        </ol>
        <br />
        <a name="_Toc280113412" href="#">
          <span />
        </a>
        <p>
          <b>Verification</b>
        </p>
        <p>You are now ready to execute the solution in the compute emulator. To enable the Table Storage trace listener dynamically without stopping the running service, you initially deploy the service with the <i>EnableTraceStorageTraceListener</i> setting disabled and then, you change the setting in the configuration file to enable the listener and then upload it to re-configure the running service. Using the log viewer application, you examine the trace messages produced by the application.</p>
        <ol>
          <li>Open the <b>Web.config</b> file of the <b>FabrikamInsurance</b> project and insert the following (highlighted) <b>customErrors</b> section as a direct child of the <b>system.web</b> element. <div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>XML</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>&lt;configuration&gt;  ...  &lt;system.web&gt;    ...<b>    &lt;customErrors mode="On" /&gt;</b>  &lt;/system.web&gt;  ...&lt;/configuration&gt;</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>When you set the <b>customErrors</b> mode to <i>On</i>, ASP.NET displays generic error messages for both local and remote clients. With <b>customErrors</b> set to its default setting of <i>RemoteOnly</i>, once the application is deployed to Windows Azure and you access it remotely, you will also see the generic errors, so this step is not strictly necessary. However, it allows you to reproduce locally the behavior that you would observe once you deploy the application to the cloud.</td></tr></table><p /></div><br /></li>
          <li>To test the solution, you need to configure the Windows Azure Project and the log viewer application so that they both start simultaneously. To define the start up projects, right-click the solution node in <b>Solution Explorer</b> and select <b>Set StartUp Projects</b>. In the <b>Solution ‘Begin’ Property Pages</b> window, make sure to select <b>Startup Project</b> under <b>Common Properties</b>, and then select the option labeled <b>Multiple startup projects</b>. Next, set the <b>Action</b> for both the <b>LogViewer</b> and <b>FabrikamInsuranceService</b> projects to <i>Start</i>, leaving the remaining projects as <i>None</i>. Click <b>OK</b> to save the changes to the start-up configuration.<p><img src="images\e2a0f5f8-68f7-4c03-be8d-9fb69f1d6889.png" /></p><p><b>Figure 16</b><br /><i>Configuring the start-up projects for the solution</i></p><br /></li>
          <li>Press <b>CTRL + F5</b> to launch the application without attaching a debugger. Again, this reproduces the conditions that you would have once you deploy the application to the cloud. Wait until the deployment completes and the browser opens to show its main page.</li>
          <li>In the browser window, complete the form making sure that you choose “<i>PORSCHE”</i> for the <b>Make</b> of the vehicle and “<i>BOXSTER (BAD DATA)</i>” for the <b>Model</b>. Notice that this time, because you enabled the <b>customErrors</b> setting in the <b>Web.config</b> file, the application shows a generic error page instead of the exception details that you saw earlier. This is what you would also see had the application been deployed to Windows Azure. <p><img src="images\8b1b6ff8-e821-49c1-ab9b-7826db165902.png" /></p><p><b>Figure 17</b><br /><i>Application error with customErrors enabled</i></p><br /></li>
          <li>Examine the output from the log viewer application. Notice that, despite the error, the console window is still empty because the table storage trace listener is currently disabled.</li>
          <li>Switch back to Visual Studio and, in <b>Solution Explorer</b>, expand the <b>Roles</b> node of the <b>FabrikamInsuranceService</b> project, and then double-click the <b>FabrikamInsurance</b> role to open its properties window. Select the <b>Settings</b> page, and then change the value of the <i>EnableTableStorageTraceListener</i> setting to <i>true</i>. </li>
          <li>Press <b>CTRL + S</b> to save the changes to the configuration.</li>
          <li>Open the compute emulator console by right-clicking its icon located in the system tray and selecting <b>Show Compute Emulator UI</b>. Record the ID for the current deployment. This is the numeric value shown enclosed in parenthesis, next to the deployment label.<p><img src="images\e70eb8a1-ec4c-47f6-89c7-6bdf720d68e7.png" /></p><p><b>Figure 18</b><br /><i>Compute Emulator UI showing the current deployment ID</i></p><br /></li>
          <li>Now, open a Windows Azure SDK command prompt from <b>Start | All Programs | Windows Azure SDK v1.X | Windows Azure SDK Command Prompt</b>. To launch the command prompt as an administrator, right-click its shortcut in the <b>Start</b> menu and choose <b>Run as administrator</b>.</li>
          <li>Change the current directory to the location of the <b>FabrikamInsuranceService</b> cloud project inside the current solution’s folder. This folder contains the service configuration file, <b>ServiceConfiguration.cscfg</b>.</li>
          <li>At the command prompt, execute the following command to update the configuration of the running deployment. Replace the [DEPLOYMENTID] placeholder with the value that you recorded earlier.<div class="code"><span codeLanguage="other"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Windows Azure Command Prompt</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>csrun /update:[DEPLOYMENTID];ServiceConfiguration.cscfg</b></pre></td></tr></table></span></div><br /><p><img src="images\8877d5bd-2134-43a0-9123-3ddb031c98ae.png" /></p><p><b>Figure 19</b><br /><i>Updating the configuration of the running service</i></p><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>For applications deployed to the cloud, you would normally update the configuration of your running application through the Windows Azure Developer Portal or by using the Windows Azure Management API to upload a new configuration file.</td></tr></table><p /></div><br /></li>
          <li>Once you have updated the configuration and enabled the trace listener, return to the browser window, browse to the <b>Quotes</b> page, and re-enter the same parameters that caused the error previously (make <i>“PORSCHE”</i>, model <i>“BOXSTER (BAD DATA)”</i>). Then, click <b>Calculate</b> to submit the form again. The response should still show the error page.</li>
          <li>Switch to the log viewer window and wait a few seconds until it refreshes.  Notice that the console now shows an entry with the error message for the unhandled exception, showing that the trace output generated by the running application is written directly to table storage.<p><img src="images\64c485ea-9644-4dc4-a29b-85544a78996b.png" /></p><p><b>Figure 20</b><br /><i>Viewer showing the error logged to table storage</i></p></li>
          <a name="_GoBack" href="#">
            <span />
          </a>
          <br />
          <li>To view the output from other informational trace messages, return to the browser window and click <b>About</b> followed by <b>Quotes</b> to execute both actions in the controller. Recall that you inserted trace messages at the start of each method. Notice that the viewer console now displays a message for each of these actions.<p><img src="images\4fb3f76a-f842-4cb2-907f-3f9fc9bd2bcd.png" /></p><p><b>Figure 21</b><br /><i>Viewer showing informational trace messages for the controller actions</i></p></li>
          <br />
          <li>In the log viewer window, press any key to exit the program.</li>
          <li>Finally, delete the running deployment in the compute emulator. To do this, right-click the deployment in the <b>Service Deployments</b> tree view and select <b>Remove</b>.</li>
        </ol>
        <br />
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to VSKitFdbk@Microsoft.com<p />Copyright © 2011 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>