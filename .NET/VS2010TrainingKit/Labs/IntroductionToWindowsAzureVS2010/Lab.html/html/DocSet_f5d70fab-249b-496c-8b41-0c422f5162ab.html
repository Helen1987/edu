<html dir="ltr" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:dt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" xmlns:xlink="http://www.w3.org/1999/xlink">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="save" content="history" />
    <xml>
      <MSHelp:TOCTitle Title="Exercise 2: Background Processing with Worker Roles and Queues" />
      <MSHelp:RLTitle Title="Exercise 2: Background Processing with Worker Roles and Queues" />
      <MSHelp:Attr Name="DocSet" Value="docSet" />
      <MSHelp:Attr Name="TopicType" Value="kbOrient" />
      <MSHelp:Attr Name="Locale" Value="kbEnglish" />
      <MSHelp:Attr Name="AssetId" Value="{GUID}" />
    </xml>
    <title>Exercise 2: Background Processing with Worker Roles and Queues</title>
    <link rel="stylesheet" type="text/css" href="../local/Classic.css" />
    <script src="../local/EventUtilities.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/SplitScreen.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/Dropdown.js" type="text/javascript" language="jscript"> </script>
    <script src="../local/script.js" type="text/javascript" language="jscript"> </script>
  </head>
  <body>
    <input type="hidden" id="userDataCache" class="userDataStyle" />
    <input type="hidden" id="hiddenScrollOffset" />
    <img id="dropDownImage" style="display:none; height:0; width:0;" alt="DropDown image" src="../local/drpdown.gif" />
    <img id="dropDownHoverImage" style="display:none; height:0; width:0;" alt="DropDownHover image" src="../local/drpdown_orange.gif" />
    <img id="collapseImage" style="display:none; height:0; width:0;" alt="Collapse image" src="../local/collapse_all.gif" />
    <img id="expandImage" style="display:none; height:0; width:0;" alt="Expand image" src="../local/expand_all.gif" />
    <img id="collapseAllImage" style="display:none; height:0; width:0;" alt="CollapseAll image" src="../local/collall.gif" />
    <img id="expandAllImage" style="display:none; height:0; width:0;" alt="ExpandAll image" src="../local/expall.gif" />
    <img id="copyImage" style="display:none; height:0; width:0;" alt="Copy image" src="../local/copycode.gif" />
    <img id="copyHoverImage" style="display:none; height:0; width:0;" alt="CopyHover image" src="../local/copycodeHighlight.gif" />
    <div id="header">
      <table width="100%" id="topTable">
        <tr id="headerTableRow1">
          <td align="left">
            <span id="runningHeaderText">Introduction to Windows Azure</span>
          </td>
        </tr>
        <tr id="headerTableRow2">
          <td align="left">
            <span id="nsrTitle">Exercise 2: Background Processing with Worker Roles and Queues</span>
          </td>
        </tr>
        <tr id="headerTableRow3">
          <td />
        </tr>
      </table>
      <table width="100%" id="bottomTable" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <span onclick="ExpandCollapseAll(toggleAllImage)" onkeypress="ExpandCollapseAll_CheckKey(toggleAllImage)" tabindex="0" style="cursor:default;display:none;">
              <img id="toggleAllImage" class="toggleAll" alt="CollapseAll image" src="../local/collall.gif" />
              <label id="collapseAllLabel" for="toggleAllImage" style="display: none;">Collapse All</label>
              <label id="expandAllLabel" for="toggleAllImage" style="display: none;">Expand All</label> </span>
            <span id="languageFilterToolTip" onmouseover="languageFilterImage.src=dropDownHoverImage.src;" onmouseout="languageFilterImage.src=dropDownImage.src;" tabindex="0" style="cursor:default;">
              <img id="languageFilterImage" alt="DropDown image" src="../local/drpdown.gif" />
              <label id="showAllLabel" for="languageFilterImage" style="display: none;">Language Filter: All</label>
              <label id="multipleLabel" for="languageFilterImage" style="display: none;">Language Filter: Multiple</label>
              <label id="vbLabel" for="languageFilterImage" style="display: none;">Language Filter: Visual Basic</label>
              <label id="csLabel" for="languageFilterImage" style="display: none;">Language Filter: C#</label>
            </span>
          </td>
        </tr>
      </table>
      <div id="languageSpan">
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="vbUsageCheckbox" />
        <label class="languageFilter" for="vbUsageCheckbox">Visual Basic Usage</label>
        <br />
        <input type="checkbox" name="languageFilter" onclick="SetLanguage(this)" id="csCheckbox" />
        <label class="languageFilter" for="csCheckbox">C#</label>
        <br />
      </div>
    </div>
    <div id="mainSection">
      <div id="mainBody">
        <div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()" />
        <p>A worker role runs in the background to provide services or execute time related tasks like a service process. </p>
        <p>In this exercise, you create a worker role to read work items posted to a queue by the web role front-end. To process the work item, the worker role extracts information about a guest book entry from the message and then retrieves the corresponding entity from table storage.  It then fetches the associated image from blob storage and creates its thumbnail, which it also stores as a blob. Finally, to complete the processing, it updates the URL of the generated thumbnail blob in the guest book entry.</p>
        <br />
        <a name="_Toc266620940" href="#">
          <span />
        </a>
        <a name="_Toc278816308" href="#">
          <span />
        </a>
        <p>
          <b>Task 1 – Creating a Worker Role to Process Images in the Background</b>
        </p>
        <p>In this task, you add a worker role project to the solution and update it so that it reads items posted by the front-end from the queue and processes them.</p>
        <ol>
          <li>If not already open, launch  Visual Studio<b> </b>as administrator from<b> Start | All Programs | Microsoft Visual Studio 2010 </b>by right clicking the <b>Microsoft Visual Studio 2010 </b>shortcut and choosing <b>Run as administrator</b>. </li>
          <li>In the <b>File</b> menu, choose <b>Open</b> and then <b>Project/Solution</b>. In the <b>Open Project</b> dialog, browse to <b>Ex2-UsingWorkerRolesAndQueues\Begin</b> in the <b>Source</b> folder of the lab, select <b>Begin.sln</b> in the folder for the language of your preference (Visual C# or Visual Basic) and click <b>Open</b>. Alternatively, you may continue with the solution that you obtained after completing the previous exercise.</li>
          <li>In <b>Solution Explorer</b>, right-click the <b>Roles</b> node in the <b>GuestBook</b> project, point to <b>Add</b> and then select <b>New Worker Role Project</b>.</li>
          <li>In the <b>Add New Role Project</b> dialog, select the <b>Worker Role</b> category and choose the <b>Worker Role</b> template for the language of your choice (Visual C# or Visual Basic). Set the name of the worker role to <b>GuestBook_WorkerRole</b> and click <b>Add</b>.<p><img src="images\c64e2bac-7265-46e9-87a6-4c5e602cf110.png" /></p><p><b>Figure 23</b><br /><i>Adding a worker role project to the solution (C#)</i></p><br /><p><img src="images\68009599-8348-4e85-9b9f-d70ba6499733.png" /></p><p><b>Figure 24</b><br /><i>Adding a worker role project to the solution (Visual Basic)</i></p><br /></li>
          <li>In the new worker role project, add a reference to the data model project. In <b>Solution Explorer</b>, right-click the <b>GuestBook_WorkerRole</b> project and select <b>Add Reference</b>, switch to the <b>Projects</b> tab, select <b>GuestBook_Data</b> and then click <b>OK</b>.</li>
          <li>Next, add a reference to the <b>System.Drawing </b>assembly, only this time, in the <b>Add Reference</b> dialog, switch to the <b>.NET</b> tab instead, select the <b>System.Drawing</b> component and then click <b>OK</b>.</li>
          <li>Now, open the <b>WorkerRole.cs</b> file (for Visual C# projects) or <b>WorkerRole.vb</b> file (for Visual Basic projects) of the <b>GuestBook_WorkerRole</b> project and insert the followings namespace declarations.<p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole Namespaces – CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>using System.Drawing;</b><b>using System.Drawing.Drawing2D;</b><b>using System.Drawing.Imaging;</b><b>using System.IO;</b><b>using GuestBook_Data;</b></pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole Namespaces – VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre><b>Imports System.Drawing</b><b>Imports System.Drawing.Drawing2D</b><b>Imports System.Drawing.Imaging</b><b>Imports System.IO</b><b>Imports GuestBook_Data</b></pre></td></tr></table></span></div><br /></li>
          <li>Add member fields to the <b>WorkerRole</b> class for the blob container and the queue, as shown below.<p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole Fields – CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class WorkerRole : RoleEntryPoint{<b>  private CloudQueue queue;</b><b>  private CloudBlobContainer container;</b>  ...}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole Fields – VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class WorkerRole  Inherits RoleEntryPoint<b>  Private queue As CloudQueue</b><b>  Private container As CloudBlobContainer</b>  ...End Class</pre></td></tr></table></span></div><br /></li>
          <li>Insert the following code into the body of the <b>OnStart</b> method immediately after the line that subscribes the <b>RoleEnvironmentChanging</b> event and before the call to the <b>OnStart</b> method in the base class.<p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole OnStart – CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class WorkerRole : RoleEntryPoint{  ...  public override bool OnStart()  {    // Set the maximum number of concurrent connections     ServicePointManager.DefaultConnectionLimit = 12;<b>    // read storage account configuration settings</b><b>    CloudStorageAccount.SetConfigurationSettingPublisher((configName, configSetter) =&gt;</b><b>    {</b><b>      configSetter(RoleEnvironment.GetConfigurationSettingValue(configName));</b><b>    });</b><b>    var storageAccount = CloudStorageAccount.FromConfigurationSetting("DataConnectionString");</b><b>    // initialize blob storage</b><b>    CloudBlobClient blobStorage = storageAccount.CreateCloudBlobClient();</b><b>    container = blobStorage.GetContainerReference("guestbookpics");</b><b>    // initialize queue storage </b><b>    CloudQueueClient queueStorage = storageAccount.CreateCloudQueueClient();</b><b>    queue = queueStorage.GetQueueReference("guestthumbs");</b><b>    Trace.TraceInformation("Creating container and queue...");</b><b>    bool storageInitialized = false;</b><b>    while (!storageInitialized)</b><b>    {</b><b>      try</b><b>      {</b><b>        // create the blob container and allow public access</b><b>        container.CreateIfNotExist();</b><b>        var permissions = container.GetPermissions();</b><b>        permissions.PublicAccess = BlobContainerPublicAccessType.Container;</b><b>        container.SetPermissions(permissions);</b><b>        // create the message queue(s)</b><b>        queue.CreateIfNotExist();</b><b>        storageInitialized = true;</b><b>      }</b><b>      catch (StorageClientException e)</b><b>      {</b><b>        if (e.ErrorCode == StorageErrorCode.TransportError)</b><b>        {</b><b>          Trace.TraceError("Storage services initialization failure. "</b><b>            + "Check your storage account configuration settings. If running locally, "</b><b>            + "ensure that the Development Storage service is running. Message: '{0}'", e.Message);</b><b>          System.Threading.Thread.Sleep(5000);</b><b>        }</b><b>        else</b><b>        {</b><b>          throw;</b><b>        }</b><b>      }</b><b>    }</b>    return base.OnStart();  }  ...}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole OnStart – VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class WorkerRole  Inherits RoleEntryPoint  ...  Public Overrides Function OnStart() As Boolean    ' Set the maximum number of concurrent connections     ServicePointManager.DefaultConnectionLimit = 12<b>    ' read storage account configuration settings</b><b>    CloudStorageAccount.SetConfigurationSettingPublisher(Function(configName, configSetter) configSetter(RoleEnvironment.GetConfigurationSettingValue(configName)))</b><b>    Dim storageAccount = CloudStorageAccount.FromConfigurationSetting("DataConnectionString")</b><b>    ' initialize blob storage</b><b>    Dim blobStorage = storageAccount.CreateCloudBlobClient()</b><b>    container = blobStorage.GetContainerReference("guestbookpics")</b><b>    ' initialize queue storage </b><b>    Dim queueStorage = storageAccount.CreateCloudQueueClient()</b><b>    queue = queueStorage.GetQueueReference("guestthumbs")</b><b>    Trace.TraceInformation("Creating container and queue...")</b><b>    Dim storageInitialized = False</b><b>    Do While (Not storageInitialized)</b><b>      Try</b><b>        ' create the blob container and allow public access</b><b>        container.CreateIfNotExist()</b><b>        Dim permissions = container.GetPermissions()</b><b>        permissions.PublicAccess = BlobContainerPublicAccessType.Container</b><b>        container.SetPermissions(permissions)</b><b>        ' create the message queue(s)</b><b>        queue.CreateIfNotExist()</b><b>        storageInitialized = True</b><b>      Catch e As StorageClientException</b><b>        If (e.ErrorCode = StorageErrorCode.TransportError) Then</b><b>          Trace.TraceError("Storage services initialization failure. " _</b><b>              &amp; "Check your storage account configuration settings. If running locally, " _</b><b>              &amp; "ensure that the Development Storage service is running. Message: '{0}'", e.Message)</b><b>          System.Threading.Thread.Sleep(5000)</b><b>        Else</b><b>          Throw</b><b>        End If</b><b>      End Try</b><b>    Loop</b>    Return MyBase.OnStart()  End Function  ...End Class</pre></td></tr></table></span></div><br /></li>
          <li>Replace the body of the <b>Run</b> method with the code shown below.<p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole Run – CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class WorkerRole : RoleEntryPoint{  ...  public override void Run()  {<b>    Trace.TraceInformation("Listening for queue messages...");</b><b>    while (true)</b><b>    {</b><b>      try</b><b>      {</b><b>        // retrieve a new message from the queue</b><b>        CloudQueueMessage msg = queue.GetMessage();</b><b>        if (msg != null)</b><b>        {</b><b>          // parse message retrieved from queue</b><b>          var messageParts = msg.AsString.Split(new char[] { ',' });</b><b>          var imageBlobUri = messageParts[0];</b><b>          var partitionKey = messageParts[1];</b><b>          var rowkey = messageParts[2];</b><b>          Trace.TraceInformation("Processing image in blob '{0}'.", imageBlobUri);</b><b>          string thumbnailBlobUri = System.Text.RegularExpressions.Regex.Replace(imageBlobUri, "([^\\.]+)(\\.[^\\.]+)?$", "$1-thumb$2");</b><b>          CloudBlob inputBlob = container.GetBlobReference(imageBlobUri);</b><b>          CloudBlob outputBlob = container.GetBlobReference(thumbnailBlobUri);</b><b>          using (BlobStream input = inputBlob.OpenRead())</b><b>          using (BlobStream output = outputBlob.OpenWrite())</b><b>          {</b><b>            ProcessImage(input, output);</b><b>            // commit the blob and set its properties</b><b>            output.Commit();</b><b>            outputBlob.Properties.ContentType = "image/jpeg";</b><b>            outputBlob.SetProperties();</b><b>            // update the entry in table storage to point to the thumbnail</b><b>            GuestBookDataSource ds = new GuestBookDataSource();</b><b>            ds.UpdateImageThumbnail(partitionKey, rowkey, thumbnailBlobUri);</b><b>            // remove message from queue</b><b>            queue.DeleteMessage(msg);</b><b>            Trace.TraceInformation("Generated thumbnail in blob '{0}'.", thumbnailBlobUri);</b><b>          }</b><b>        }</b><b>        else</b><b>        {</b><b>          System.Threading.Thread.Sleep(1000);</b><b>        }</b><b>      }</b><b>      catch (StorageClientException e)</b><b>      {</b><b>        Trace.TraceError("Exception when processing queue item. Message: '{0}'", e.Message);</b><b>        System.Threading.Thread.Sleep(5000);</b><b>      }</b><b>    }</b>  }  ...}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 WorkerRole Run – VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class WorkerRole  Inherits RoleEntryPoint  ...  Public Overrides Sub Run()<b>    Trace.TraceInformation("Listening for queue messages...")</b><b>    Do</b><b>      Try</b><b>        ' retrieve a new message from the queue</b><b>        Dim msg As CloudQueueMessage = queue.GetMessage()</b><b>        If msg IsNot Nothing Then</b><b>          ' parse message retrieved from queue</b><b>          Dim messageParts = msg.AsString.Split(New Char() {","c})</b><b>          Dim imageBlobUri = messageParts(0)</b><b>          Dim partitionKey = messageParts(1)</b><b>          Dim rowKey = messageParts(2)</b><b>          Trace.TraceInformation("Processing image in blob '{0}'.", imageBlobUri)</b><b>          Dim thumbnailBlobUri As String = System.Text.RegularExpressions.Regex.Replace(imageBlobUri, "([^\\.]+)(\\.[^\\.]+)?$", "$1-thumb$2")</b><b>          ' download original image from blob storage</b><b>          Dim inputBlob As CloudBlockBlob = container.GetBlockBlobReference(imageBlobUri)</b><b>          Dim outputBlob As CloudBlockBlob = container.GetBlockBlobReference(thumbnailBlobUri)</b><b>          Using input As BlobStream = inputBlob.OpenRead()</b><b>            Using output As BlobStream = outputBlob.OpenWrite()</b><b>              ProcessImage(input, output)</b><b>              ' commit the blob and set its properties</b><b>              output.Commit()</b><b>              outputBlob.Properties.ContentType = "image/jpeg"</b><b>              outputBlob.SetProperties()</b><b>              ' update the entry in table storage to point to the thumbnail</b><b>              Dim ds = New GuestBookDataSource()</b><b>              ds.UpdateImageThumbnail(partitionKey, rowKey, thumbnailBlobUri)</b><b>              ' remove message from queue</b><b>              queue.DeleteMessage(msg)</b><b>              Trace.TraceInformation("Generated thumbnail in blob '{0}'.", thumbnailBlobUri)</b><b>            End Using</b><b>          End Using</b><b>        Else</b><b>          System.Threading.Thread.Sleep(1000)</b><b>        End If</b><b>      Catch e As StorageClientException</b><b>        Trace.TraceError("Exception when processing queue item. Message: '{0}'", e.Message)</b><b>        System.Threading.Thread.Sleep(5000)</b><b>      End Try</b><b>    Loop</b>  End Sub  ...End Class</pre></td></tr></table></span></div><br /></li>
          <li>Finally, add the following method to the <b>WorkerRole</b> class to create thumbnails from a given image.<p>(Code Snippet – <i>Introduction to Windows Azure -</i><i>Ex2 ProcessImage – CS</i>)</p><div class="code"><span codeLanguage="CSharp"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>C#</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>public class WorkerRole : RoleEntryPoint{  ...<b>  public void ProcessImage(Stream input, Stream output)</b><b>  {</b><b>    int width;</b><b>    int height;</b><b>    var originalImage = new Bitmap(input);</b><b>    if (originalImage.Width &gt; originalImage.Height)</b><b>    {</b><b>      width = 128;</b><b>      height = 128 * originalImage.Height / originalImage.Width;</b><b>    }</b><b>    else</b><b>    {</b><b>      height = 128;</b><b>      width = 128 * originalImage.Width / originalImage.Height;</b><b>    }</b><b>    var thumbnailImage = new Bitmap(width, height);</b><b>    using (Graphics graphics = Graphics.FromImage(thumbnailImage))</b><b>    {</b><b>      graphics.InterpolationMode = InterpolationMode.HighQualityBicubic;</b><b>      graphics.SmoothingMode = SmoothingMode.AntiAlias;</b><b>      graphics.PixelOffsetMode = PixelOffsetMode.HighQuality;</b><b>      graphics.DrawImage(originalImage, 0, 0, width, height);</b><b>    }</b><b>    thumbnailImage.Save(output, ImageFormat.Jpeg);</b><b>  }</b>}</pre></td></tr></table></span></div><br /><p>(Code Snippet – <i>Introduction to Windows Azure - Ex2 ProcessImage – VB</i>)</p><div class="code"><span codeLanguage="VisualBasicUsage"><table width="100%" cellspacing="0" cellpadding="0"><tr><th>Visual Basic</th><th><span class="copyCode" onclick="CopyCode(this)" onkeypress="CopyCode_CheckKey(this)" onmouseover="ChangeCopyCodeIcon(this)" onfocusin="ChangeCopyCodeIcon(this)" onmouseout="ChangeCopyCodeIcon(this)" onfocusout="ChangeCopyCodeIcon(this)" tabindex="0"><img class="copyCodeImage" name="ccImage" align="absmiddle" src="../local/copycode.gif" />Copy Code
                  </span></th></tr><tr><td colspan="2"><pre>Public Class WorkerRole  Inherits RoleEntryPoint  ...<b>  Private Sub ProcessImage(ByVal input As Stream, ByVal output As Stream)</b><b>    Dim width As Integer</b><b>    Dim height As Integer</b><b>    Dim originalImage As New Bitmap(input)</b><b>    If originalImage.Width &gt; originalImage.Height Then</b><b>      width = 128</b><b>      height = 128 * originalImage.Height / originalImage.Width</b><b>    Else</b><b>      height = 128</b><b>      width = 128 * originalImage.Width / originalImage.Height</b><b>    End If</b><b>    Dim thumbnailImage As New Bitmap(width, height)</b><b>    Using graphic = Graphics.FromImage(thumbnailImage)</b><b>      graphic.InterpolationMode = InterpolationMode.HighQualityBicubic</b><b>      graphic.SmoothingMode = SmoothingMode.AntiAlias</b><b>      graphic.PixelOffsetMode = PixelOffsetMode.HighQuality</b><b>      graphic.DrawImage(originalImage, 0, 0, width, height)</b><b>    End Using</b><b>    thumbnailImage.Save(output, ImageFormat.Jpeg)</b><b>  End Sub</b>End Class</pre></td></tr></table></span></div><br /><div class="alert"><table width="100%" cellspacing="0" cellpadding="0"><tr><th align="left"><img class="note" src="../local/note.gif" />Note:</th></tr><tr><td>Even though the code shown above uses classes in the System.Drawing namespace for simplicity, you should be aware that the classes in this namespace were designed for use with Windows Forms. They are not supported for use within a Windows or ASP.NET service. You should conduct exhaustive testing if you intend to use these classes in your own Windows Azure applications.</td></tr></table><p /></div><br /></li>
          <li>The worker role also uses Windows Azure storage services and you need to configure your storage account settings, just as you did in the case of the web role. To create the storage account setting, in <b>Solution Explorer</b>, expand the <b>Roles</b> node of the <b>GuestBook</b> project, double-click <b>GuestBook_WorkerRole</b> to open the properties for this role and select the <b>Settings</b> tab. Click <b>Add Setting</b>, type “<i>DataConnectionString</i>” in the <b>Name</b> column, change the <b>Type</b> to <i>ConnectionString</i>, and then click the button labeled  with an ellipsis. In the <b>Storage Account Connection String</b> dialog, choose the option labeled <b>Use the Windows Azure storage emulator</b> and click <b>OK</b>. Press <b>CTRL + S</b> to save your changes.</li>
        </ol>
        <br />
        <a name="_Toc266620941" href="#">
          <span />
        </a>
        <a name="_Toc278816309" href="#">
          <span />
        </a>
        <p>
          <b>Verification</b>
        </p>
        <p>You now launch the updated application in the Windows Azure compute emulator to verify that the worker role can retrieve queued work items and generate the corresponding thumbnails.</p>
        <ol>
          <li>Press <b>F5</b> to launch the service in the local compute emulator. </li>
          <li>Switch to Internet Explorer to view the application. Provided you completed the verification section of the previous exercise successfully, you will see the guest book entry that you entered, including the uploaded image displayed in its original size. If you recall, during the last task of that exercise, you updated the web role code to post a work item to a queue for each new entry submitted. These messages remain in the queue even though the web role was subsequently recycled. </li>
          <li>Wait a few seconds until the worker role picks up the queued message and processes the image that you are viewing. Once that occurs, it generates a thumbnail for this image and updates the corresponding URL property for the entry in table storage. Eventually, because the page refreshes every few seconds, it will show the thumbnail image instead.<p><img src="images\ecae1395-c947-4770-afe3-e01b5960df6c.png" /></p><p><b>Figure 25</b><br /><i>Home page showing the thumbnail generated by the worker role</i></p><br /></li>
          <li>If you are using Visual Studio 2010, in <b>Server Explorer</b>, expand the <b>Blobs</b> node in the <b>Windows Azure Storage</b> node, and then double-click the <i>guestbookpics</i> container. Notice that it now contains an additional blob for the generated thumbnail image.<p><img src="images\26196054-ee13-4807-a990-0dd0b60497f5.png" /></p><p><b>Figure 26</b><br /><i>Blob container showing the blob for the generated thumbnail</i></p><br /></li>
          <li>Add some more guest book entries. Notice that the images update after a few seconds once the worker role processes the thumbnails.</li>
          <li>Press <b>SHIFT + F5</b> to stop the debugger and shut down the deployment in the compute emulator.</li>
        </ol>
        <br />
      </div>
      <div id="footer">
        <div class="footerLine">
          <img src="../local/footer.gif" alt="Footer image" width="100%" height="3px" />
        </div>To give feedback please write to VSKitFdbk@Microsoft.com<p />Copyright © 2011 by Microsoft Corporation. All rights reserved.</div>
    </div>
  </body>
</html>